<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜è³¼é»é¤å°å¹«æ‰‹ - å¤šäººç®¡ç†ç‰ˆ</title>
    
    <!-- å¼•å…¥å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF9AA2',   // ç”œå¿ƒç²‰
                        primaryDark: '#FF8090', 
                        secondary: '#FFDAC1', // èœœæ¡ƒè†š
                        accent: '#B5EAD7',    // è–„è·ç¶ 
                        softYellow: '#FFF5BA',
                        textMain: '#6D6875',  
                        bgBase: '#FFFAF4',    
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 2s ease-in-out infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #FFFAF4; color: #6D6875; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 2px solid #fff;
            box-shadow: 0 8px 32px rgba(255, 154, 162, 0.15);
        }
        .loading-spinner {
            border: 4px solid #fff;
            border-top: 4px solid #FF9AA2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-bounce:active { transform: scale(0.95); }
    </style>
</head>
<body class="selection:bg-secondary selection:text-primaryDark">

    <!-- å…¨åŸŸè¼‰å…¥é®ç½© -->
    <div id="globalLoader" class="fixed inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center transition-opacity duration-500 backdrop-blur-sm">
        <div class="loading-spinner mb-4 shadow-lg bg-white p-1"></div>
        <p class="text-primary font-bold animate-pulse text-lg tracking-widest">LOADING...</p>
    </div>

    <!-- å°èˆªåˆ— -->
    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-secondary/30">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="window.app.router.go('home')">
                <div class="bg-primary text-white w-9 h-9 rounded-2xl flex items-center justify-center font-bold shadow-md group-hover:rotate-12 transition-transform">
                    <i class="fa-solid fa-utensils"></i>
                </div>
                <h1 class="text-lg font-bold text-textMain group-hover:text-primary transition-colors">é»é¤å°å¹«æ‰‹</h1>
            </div>
            <div class="flex gap-2 items-center">
                <span id="nav-user-info" class="text-xs font-bold text-primary hidden"></span>
                <button id="btn-logout" onclick="window.app.auth.logout()" class="text-xs px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition hidden">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-2xl mx-auto p-4 pb-28 min-h-screen">
        
        <!-- 0. ç™»å…¥é é¢ (Login View) -->
        <div id="view-login" class="view-section hidden flex flex-col items-center justify-center min-h-[60vh] animate-fade-in">
            <div class="glass-panel p-8 rounded-[2.5rem] w-full max-w-sm shadow-xl text-center relative overflow-hidden transition-all duration-300">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-primary/20 rounded-full blur-3xl"></div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-accent/20 rounded-full blur-3xl"></div>
                
                <h2 class="text-2xl font-bold text-textMain mb-2 relative z-10" id="login-title">æ­¡è¿ä½¿ç”¨ ğŸ½ï¸</h2>
                <p class="text-sm text-gray-400 mb-8 relative z-10" id="login-subtitle">è¨‚é¤ä¸»æªä½¿ç”¨è€…ç™»å…¥</p>

                <form onsubmit="window.app.auth.login(event)" class="space-y-4 relative z-10">
                    <div class="text-left transition-all duration-300" id="login-username-container">
                        <label class="text-xs font-bold text-gray-500 ml-2">ä½¿ç”¨è€…ä»£è™Ÿ (User ID)</label>
                        <input type="text" id="login-username" placeholder="ä¾‹å¦‚: happy_eat" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary/50 transition font-bold text-gray-700">
                    </div>
                    <div class="text-left">
                        <label class="text-xs font-bold text-gray-500 ml-2">å¯†ç¢¼ (Password)</label>
                        <input type="password" id="login-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary/50 transition font-bold text-gray-700">
                    </div>
                    <button type="submit" id="btn-login-submit" class="w-full bg-primary hover:bg-primaryDark text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 transition-all text-lg btn-bounce">
                        ç™»å…¥ / è¨»å†Š
                    </button>
                    
                    <div class="flex justify-between items-center pt-2">
                         <p class="text-[10px] text-gray-400" id="login-hint">* é¦–æ¬¡ç™»å…¥å°‡è‡ªå‹•å»ºç«‹å¸³è™Ÿ</p>
                         <button type="button" onclick="window.app.auth.toggleLoginMode()" id="btn-toggle-login" class="text-xs font-bold text-primary hover:underline">æˆ‘æ˜¯ç®¡ç†å“¡</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 1. é¦–é  (Dashboard) -->
        <div id="view-home" class="view-section hidden space-y-6 animate-fade-in">
            <!-- API Key Alert -->
            <div id="api-key-alert" class="hidden bg-white/80 border-l-4 border-primary p-5 rounded-2xl shadow-sm backdrop-blur-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 text-9xl -mr-4 -mt-4 text-primary pointer-events-none"><i class="fa-solid fa-robot"></i></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-primary"></i> <span id="api-key-msg-title">å°šæœªè¨­å®š AI é‡‘é‘°</span></h3>
                    <p class="text-sm text-gray-500 mt-1">ç‚ºäº†ä½¿ç”¨èœå–®è‡ªå‹•è¾¨è­˜åŠŸèƒ½ï¼Œè«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Keyã€‚</p>
                    <div class="mt-3 text-sm bg-blue-50 text-blue-700 p-3 rounded-xl border border-blue-100 inline-block">ğŸ’¡ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-bold underline hover:text-blue-900">é»æ­¤å…è²»ç”³è«‹ Google Gemini API Key</a></div>
                    <div class="mt-4 flex gap-2"><input type="password" id="home-api-key-input" placeholder="è²¼ä¸Š API Key (AIza...)" class="flex-1 p-3 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary/50 outline-none"><button onclick="window.app.config.saveFromHome()" class="bg-gray-800 text-white px-5 py-2 rounded-xl font-bold text-sm hover:bg-gray-700 transition shadow-lg">å„²å­˜</button></div>
                    <p class="text-[10px] text-gray-400 mt-2">* ç‚ºäº†è³‡è¨Šå®‰å…¨ï¼ŒKey åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸¦æ–¼ 30 å¤©å¾Œè‡ªå‹•å¤±æ•ˆéœ€é‡æ–°è¼¸å…¥ã€‚</p>
                </div>
            </div>

            <!-- Welcome Card -->
            <div class="glass-panel rounded-[2rem] p-8 text-center relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-softYellow rounded-full opacity-50 blur-2xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-accent rounded-full opacity-50 blur-2xl"></div>
                <h2 class="text-3xl font-bold mb-2 text-textMain relative z-10">ä»Šå¤©æƒ³å–é»ä»€éº¼ï¼ŸğŸ¹</h2>
                <p class="text-gray-400 mb-8 text-sm relative z-10">è¼•é¬†é–‹åœ˜ â€§ è‡ªå‹•çµ±è¨ˆ â€§ å¿«æ¨‚åˆ†äº«</p>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <button onclick="window.app.router.go('create-order')" class="btn-bounce group relative overflow-hidden bg-primary text-white p-6 rounded-3xl shadow-lg shadow-primary/30 transition-all">
                        <div class="absolute -right-4 -top-4 w-16 h-16 bg-white opacity-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                        <i class="fa-solid fa-plus text-3xl mb-3 block"></i>
                        <span class="font-bold text-lg">æˆ‘è¦é–‹åœ˜</span>
                    </button>
                    <button onclick="window.app.router.go('store-manage')" class="btn-bounce bg-white text-primary border-2 border-primary/20 p-6 rounded-3xl shadow-sm hover:bg-white hover:border-primary transition-all">
                        <i class="fa-solid fa-store text-3xl mb-3 block text-secondary"></i>
                        <span class="font-bold text-lg text-textMain">æˆ‘çš„åº—å®¶</span>
                    </button>
                </div>
                
                <!-- Admin Button (Hidden by default) -->
                <button id="btn-admin-panel" onclick="window.app.router.go('admin-panel')" class="hidden mt-4 w-full py-3 bg-gray-800 text-white rounded-xl font-bold text-sm hover:bg-gray-700 transition relative z-10">
                    <i class="fa-solid fa-user-shield mr-2"></i> ç®¡ç†è€…å¾Œå° (åº—å®¶æ´¾é€)
                </button>
            </div>
            
            <div>
                <h3 class="font-bold text-textMain ml-2 mb-3 flex items-center gap-2 text-lg">
                    <span class="w-2 h-6 bg-accent rounded-full"></span> æœ€è¿‘é–‹çš„åœ˜
                </h3>
                <div id="home-order-list" class="space-y-3">
                    <!-- History List -->
                    <div class="text-center py-12 text-gray-300 bg-white/60 rounded-3xl border border-dashed border-gray-300">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-30"></i>
                        <p>å°šç„¡è¨‚å–®è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. ç®¡ç†è€…å¾Œå° (Admin Panel) -->
        <div id="view-admin-panel" class="view-section hidden space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-textMain">å…¨åŸŸåº—å®¶ç®¡ç† ğŸ›¡ï¸</h2>
                <div class="flex gap-2">
                     <button onclick="window.app.admin.showChangePasswordModal()" class="text-xs bg-white border border-gray-200 px-3 py-1.5 rounded-full font-bold text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-key mr-1"></i>ä¿®æ”¹å¯†ç¢¼</button>
                     <button onclick="window.app.router.go('home')" class="text-xs text-gray-500 border border-gray-200 px-3 py-1.5 rounded-full hover:bg-gray-50">è¿”å›</button>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 text-sm text-indigo-900 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-users"></i> ä½¿ç”¨è€…ç®¡ç†</h3>
                    <button onclick="window.app.admin.showCreateUserModal()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700">ï¼‹ æ–°å¢ä¸»æª</button>
                </div>
                <div id="admin-user-list" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- JS Render Users -->
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-sm text-blue-800">
                <i class="fa-solid fa-circle-info mr-1"></i> æ‚¨æ˜¯ç®¡ç†è€…ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨è€…çš„åº—å®¶ï¼Œä¸¦å°‡å…¶è¤‡è£½çµ¦ç‰¹å®šä½¿ç”¨è€…ã€‚
            </div>
            
            <div id="admin-all-stores-list" class="space-y-3 pb-24">
                <!-- JS Render All Stores -->
            </div>
        </div>

        <!-- 2. åº—å®¶åˆ—è¡¨ -->
        <div id="view-store-manage" class="view-section hidden space-y-4">
            <div class="flex items-center justify-between"><h2 class="text-2xl font-bold text-textMain">æˆ‘çš„åº—å®¶åˆ—è¡¨ ğŸª</h2><button onclick="window.app.store.showAddModal()" class="bg-primary hover:bg-primaryDark text-white px-5 py-2.5 rounded-full text-sm shadow-lg shadow-primary/30 transition-all font-bold"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div>
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="store-category-filter"></div><div id="store-list" class="grid gap-4"></div><button onclick="window.app.router.go('home')" class="w-full py-4 text-gray-400 font-bold hover:text-textMain transition">â† å›é¦–é </button>
        </div>
        <!-- 3. é–‹åœ˜è¨­å®š -->
        <div id="view-create-order" class="view-section hidden space-y-6"><div class="glass-panel p-6 rounded-[2rem]"><h2 class="text-xl font-bold mb-6 border-b border-gray-100 pb-4 text-center">âœ¨ ç™¼èµ·åœ˜è³¼</h2><form onsubmit="window.app.order.create(event)" class="space-y-5"><div><label class="block text-sm font-bold text-textMain mb-2 ml-1">é¸æ“‡åº—å®¶</label><div class="relative"><select id="create-order-store" required class="w-full p-4 bg-secondary/10 rounded-2xl border border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none appearance-none font-bold text-gray-600 transition-all"><option value="">è«‹é¸æ“‡...</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i></div></div><div><label class="block text-sm font-bold text-textMain mb-2 ml-1">è¨‚è³¼æ¨™é¡Œ</label><input type="text" id="create-order-title" required placeholder="ä¾‹å¦‚ï¼šé€±äº”æ­¡æ¨‚ä¸‹åˆèŒ¶ ğŸ§‹" class="w-full p-4 bg-secondary/10 rounded-2xl border border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none font-bold text-gray-600 transition-all"></div><button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 transition-all text-lg btn-bounce mt-4">å»ºç«‹ä¸¦å–å¾—é€£çµ ğŸ”—</button></form></div><button onclick="window.app.router.go('home')" class="w-full text-center text-gray-400 font-bold">å–æ¶ˆ</button></div>
        <!-- 4. é»é¤é é¢ -->
        <div id="view-order-menu" class="view-section hidden"><div class="glass-panel p-5 rounded-b-[2rem] mb-4 sticky top-14 z-30 shadow-sm"><div class="flex justify-between items-start mb-3"><div class="flex-1"><h2 id="menu-order-title" class="text-lg font-bold text-textMain">è¼‰å…¥ä¸­...</h2><div id="menu-store-name" class="text-sm text-gray-400 mt-1 flex items-center gap-1"></div></div><span id="menu-status-badge" class="px-3 py-1 bg-accent/30 text-teal-700 text-xs rounded-full font-bold">é€²è¡Œä¸­</span></div><div id="menu-contact-actions" class="flex gap-2 border-t border-gray-100 pt-3 hidden"><a id="btn-call-store" href="#" class="flex-1 py-2 bg-gray-50 rounded-xl text-xs font-bold text-gray-600 text-center hover:bg-green-50 hover:text-green-600 transition"><i class="fa-solid fa-phone mr-1"></i> æ’¥æ‰“é›»è©±</a><a id="btn-open-store-link" href="#" target="_blank" class="flex-1 py-2 bg-gray-50 rounded-xl text-xs font-bold text-gray-600 text-center hover:bg-blue-50 hover:text-blue-600 transition"><i class="fa-solid fa-link mr-1"></i> å•†å®¶ç³»çµ±</a></div></div><div id="menu-category-nav" class="flex gap-2 overflow-x-auto px-4 pb-2 mb-2 no-scrollbar sticky top-[11rem] z-20 py-2"></div><div id="menu-items-container" class="space-y-8 px-4 pb-28"></div><div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md shadow-[0_-8px_30px_rgba(0,0,0,0.08)] p-4 z-50 rounded-t-[2rem] border-t border-gray-100"><div class="max-w-2xl mx-auto flex items-center justify-between"><div onclick="window.app.order.showCartModal()" class="cursor-pointer group pl-2"><p class="text-[10px] text-gray-400 font-bold mb-0.5 group-hover:text-primary transition">ç›®å‰é¸æ“‡</p><div class="flex items-center gap-3"><span class="font-bold text-2xl text-textMain" id="cart-total-price">$0</span><span class="bg-primary text-white text-xs px-2 py-0.5 rounded-full font-bold shadow-sm" id="cart-count">0</span></div></div><button onclick="window.app.order.showSubmitModal()" class="bg-textMain text-white px-8 py-3.5 rounded-2xl font-bold hover:bg-gray-800 transition shadow-lg shadow-gray-300 btn-bounce flex items-center gap-2"><span>é¸å¥½äº†</span> <i class="fa-solid fa-arrow-right"></i></button></div></div></div>
        <!-- 5. åœ˜ä¸»ç®¡ç† -->
        <div id="view-admin-dashboard" class="view-section hidden space-y-6"><div class="glass-panel p-5 rounded-[2rem] flex justify-between items-center"><div><h2 id="admin-title" class="font-bold text-lg text-textMain">è¨‚å–®çµ±è¨ˆ</h2><p class="text-xs text-gray-400 mt-1">ID: <span id="admin-order-id"></span></p><p id="admin-store-phone" class="text-xs text-primary font-bold mt-1 cursor-pointer hidden"><i class="fa-solid fa-phone"></i> <span></span></p></div><button onclick="window.app.router.go('home')" class="text-xs text-gray-500 border-2 border-gray-100 px-4 py-2 rounded-full font-bold hover:bg-gray-50">è¿”å›</button></div><div class="grid grid-cols-2 gap-4"><div class="bg-secondary/30 p-5 rounded-[2rem] text-center border border-secondary/20"><p class="text-xs text-gray-500 mb-1 font-bold">ç¸½é‡‘é¡</p><p id="admin-total-amount" class="text-2xl font-bold text-primary">$0</p></div><div class="bg-accent/30 p-5 rounded-[2rem] text-center border border-accent/20"><p class="text-xs text-gray-500 mb-1 font-bold">ç¸½ä»½æ•¸</p><p id="admin-total-count" class="text-2xl font-bold text-teal-600">0</p></div></div><div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100"><h3 class="font-bold text-sm mb-4 text-center">ğŸ‘‡ åˆ†äº«é€£çµ</h3><div id="qrcode-container" class="flex justify-center mb-6 p-4 bg-white rounded-xl border-2 border-dashed border-gray-200 w-fit mx-auto"></div><div class="flex gap-2"><input type="text" id="share-link-input" readonly class="flex-1 bg-gray-50 text-xs px-4 py-3 rounded-xl"><button onclick="window.app.utils.copyLink()" class="bg-textMain text-white px-5 rounded-xl text-xs font-bold">è¤‡è£½</button></div></div><div class="bg-white rounded-[2rem] shadow-sm overflow-hidden border border-gray-100"><div class="flex p-2 bg-gray-50/80 gap-2"><button onclick="window.app.admin.switchTab('items')" id="tab-items" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white shadow-sm transition-all">å“é …çµ±è¨ˆ</button><button onclick="window.app.admin.switchTab('people')" id="tab-people" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 transition-all">äººååˆ—è¡¨</button></div><div id="admin-list-container" class="p-5 max-h-[400px] overflow-y-auto"></div></div><button onclick="window.app.admin.exportCSV()" class="w-full bg-accent hover:brightness-95 text-teal-800 py-4 rounded-[2rem] font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-file-csv"></i> åŒ¯å‡º Excel</button></div>
        <!-- 6. åº—å®¶è©³æƒ… -->
        <div id="view-store-detail" class="view-section hidden"><div class="glass-panel p-5 rounded-b-[2rem] mb-4 sticky top-14 z-30 shadow-sm"><div class="flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2"><div id="detail-store-icon" class="text-2xl"></div><h2 id="detail-store-name" class="text-xl font-bold text-textMain">...</h2></div><div class="flex flex-wrap gap-2 mt-2"><span id="detail-store-category" class="text-[10px] bg-softYellow text-orange-700 px-2 py-1 rounded-full font-bold hidden">åˆ†é¡</span><a id="detail-store-phone" href="#" class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded-full font-bold hidden border border-green-100"><i class="fa-solid fa-phone mr-1"></i><span></span></a><a id="detail-store-link" href="#" target="_blank" class="text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded-full font-bold hidden border border-blue-100"><i class="fa-solid fa-link mr-1"></i>ç³»çµ±</a></div></div><button onclick="window.app.router.go('store-manage')" class="text-xs text-gray-400 border border-gray-200 px-3 py-1.5 rounded-full hover:bg-gray-50">è¿”å›</button></div><div id="store-owner-actions" class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-gray-100"><button onclick="window.app.store.quickAddMode()" class="py-2 bg-primary/10 text-primary rounded-xl text-xs font-bold hover:bg-primary hover:text-white transition flex flex-col items-center gap-1"><i class="fa-solid fa-plus-circle text-lg"></i> å¢åŠ å“é …</button><button onclick="window.app.store.retakePhoto()" class="py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100 transition flex flex-col items-center gap-1"><i class="fa-solid fa-camera text-lg"></i> é‡æ–°æ‹ç…§</button><button onclick="window.app.store.deleteStore()" class="py-2 bg-red-50 text-red-500 rounded-xl text-xs font-bold hover:bg-red-100 transition flex flex-col items-center gap-1"><i class="fa-solid fa-trash-can text-lg"></i> åˆªé™¤åº—å®¶</button></div></div><div id="detail-menu-container" class="space-y-8 px-4 pb-28"></div></div>

    </main>

    <!-- Modals -->
    <!-- Modal: Create User (Admin) -->
    <div id="modal-create-user" class="fixed inset-0 bg-black/40 hidden z-[65] items-center justify-center p-4 backdrop-blur-sm flex">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-scale-up border-4 border-white">
            <h3 class="font-bold text-lg mb-4 text-center text-textMain">æ–°å¢ä½¿ç”¨è€…</h3>
            <form onsubmit="window.app.admin.createUser(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 text-gray-400">ä»£è™Ÿ</label>
                    <input type="text" id="new-user-name" required placeholder="ä¾‹å¦‚: happy_eat" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 text-gray-400">å¯†ç¢¼</label>
                    <input type="password" id="new-user-pass" required placeholder="è‡³å°‘6ç¢¼" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary/20">
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 text-gray-400">æ¬Šé™</label>
                    <select id="new-user-role" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        <option value="initiator">ä¸»æª</option>
                        <option value="admin">ç®¡ç†å“¡</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="window.app.ui.closeModal('modal-create-user')" class="flex-1 py-3 text-gray-400 font-bold hover:bg-gray-50 rounded-xl">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Config (Re-added for safety) -->
    <div id="modal-config" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md transition-opacity"><div class="bg-white rounded-[2rem] w-full max-w-md p-6 shadow-2xl animate-scale-up max-h-[90vh] overflow-y-auto border-4 border-white"><h3 class="text-xl font-bold mb-6 text-center text-textMain">âš™ï¸ ç³»çµ±è¨­å®š</h3><p id="config-error-msg" class="text-xs text-red-500 mb-2 hidden"></p><div class="mb-5"><label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">Base URL (éƒ¨ç½²å¾Œä¿®æ”¹)</label><input type="text" id="config-base-url" class="w-full p-3 bg-gray-50 rounded-xl text-sm border border-gray-100 focus:ring-2 focus:ring-primary/20 outline-none transition" placeholder="https://..."></div><div class="mb-5"><label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">Firebase Config</label><textarea id="config-input" class="w-full h-32 p-3 bg-gray-50 rounded-xl text-xs font-mono border border-gray-100 focus:ring-2 focus:ring-primary/20 outline-none transition" placeholder="apiKey: 'AIza...',&#10;authDomain: '...', ..."></textarea></div><div class="mb-6"><label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">AI (Gemini)</label><div class="flex gap-2 mb-3 bg-gray-50 p-1 rounded-xl"><button onclick="window.app.config.setAiMode('default')" id="btn-ai-default" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all">é è¨­ (å…è²»)</button><button onclick="window.app.config.setAiMode('custom')" id="btn-ai-custom" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all text-gray-400">è‡ªè¨‚ Key</button></div><input type="password" id="custom-ai-key" class="w-full p-3 bg-white border border-gray-200 rounded-xl text-sm hidden focus:border-primary outline-none" placeholder="è¼¸å…¥ API Key"></div><div class="mb-6 border-t border-gray-100 pt-4"><button onclick="window.app.config.generateShareUrl()" class="w-full bg-textMain text-white py-3 rounded-xl text-sm font-bold hover:bg-gray-700 transition"><i class="fa-solid fa-share-nodes mr-2"></i> ç”¢ç”Ÿå«è¨­å®šçš„åˆ†äº«é€£çµ</button><div id="config-share-result" class="hidden mt-4 bg-gray-50 p-4 rounded-xl text-center"><div id="config-qrcode" class="flex justify-center mb-3 bg-white p-2 w-fit mx-auto rounded-lg"></div><input type="text" id="config-share-url" readonly class="w-full text-xs p-2 bg-white rounded border border-gray-200 text-gray-500 mb-1 text-center"></div></div><div class="flex gap-3"><button onclick="window.app.ui.closeModal('modal-config')" class="flex-1 py-3 text-gray-400 font-bold hover:bg-gray-50 rounded-xl transition">é—œé–‰</button><button onclick="window.app.config.save()" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 hover:bg-primaryDark transition">å„²å­˜</button></div></div></div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp, getApps, getApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, orderBy, onSnapshot, serverTimestamp, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const HARDCODED_CONFIG = {
            apiKey: "AIzaSyCfP75XPViRbVsTRlsQDY2Caty-iuIGDsQ",
            authDomain: "grouporderapp-c7036.firebaseapp.com",
            projectId: "grouporderapp-c7036",
            storageBucket: "grouporderapp-c7036.firebasestorage.app",
            messagingSenderId: "1087210025698",
            appId: "1:1087210025698:web:f0507fc2ad84721504e4bb"
        };
        const HARDCODED_GEMINI_KEY = ""; 

        window.db = null; window.auth = null; window.currentUser = null;
        const appId = 'food-ordering-app';

        // ç¢ºä¿ window.app å®šç¾©å®Œæ•´
        window.app = {
            state: {
                currentView: 'login', 
                stores: [],
                allStoresAdmin: [], 
                allUsers: [], 
                currentOrder: null,
                cart: [], 
                aiMode: localStorage.getItem(`${appId}_ai_mode`) || 'default',
                baseUrl: localStorage.getItem(`${appId}_base_url`) || (window.location.origin + window.location.pathname),
                tempItem: null,
                viewingStoreId: null, 
                userRole: 'initiator',
                isAdminLoginMode: false
            },

            // 1. Router Module
            router: {
                go: (viewName, params = {}) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    const target = document.getElementById(`view-${viewName}`);
                    if (target) {
                        target.classList.remove('hidden');
                        window.scrollTo(0,0);
                        // Trigger view specific logic
                        if (viewName === 'admin-panel') window.app.admin.loadAllData();
                        if (viewName === 'home') window.app.order.loadHistory();
                        if (viewName === 'store-manage') window.app.store.renderList();
                        if (viewName === 'create-order') window.app.store.renderSelectOptions();
                        if (viewName === 'order-menu' && params.orderId) window.app.order.initMenu(params.orderId);
                        if (viewName === 'admin-dashboard' && params.orderId) window.app.admin.init(params.orderId);
                    } else {
                        console.error(`View ${viewName} not found`);
                    }
                }
            },

            // 2. UI Module
            ui: {
                showConfigModal: () => {
                    document.getElementById('modal-config').classList.remove('hidden');
                    document.getElementById('modal-config').classList.add('flex');
                    let stored = localStorage.getItem(`${appId}_firebase_config`);
                    if(!stored && HARDCODED_CONFIG.apiKey !== 'demo') stored = JSON.stringify(HARDCODED_CONFIG);
                    if (stored) {
                        const c = JSON.parse(stored);
                        let str = ""; for (let k in c) str += `${k}: "${c[k]}",\n`;
                        document.getElementById('config-input').value = str;
                    }
                    document.getElementById('config-base-url').value = window.app.state.baseUrl;
                    window.app.config.setAiMode(window.app.state.aiMode);
                },
                closeModal: (id) => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                },
                showHelpModal: () => alert("è«‹å‰å¾€ Firebase Console -> Project Settings -> General -> è¤‡è£½è¨­å®šã€‚")
            },

            // 3. Init
            init: async () => { await window.app.config.load(); },

            // 4. Config
            config: {
                load: async () => {
                    let finalConfig = null;
                    const urlParams = new URLSearchParams(window.location.search);
                    const encodedConfig = urlParams.get('config');
                    if (encodedConfig) {
                        try {
                            finalConfig = JSON.parse(atob(encodedConfig));
                            localStorage.setItem(`${appId}_firebase_config`, JSON.stringify(finalConfig));
                            const newUrl = window.location.pathname + (urlParams.get('orderId') ? `?orderId=${urlParams.get('orderId')}` : '');
                            window.history.replaceState({}, document.title, newUrl);
                        } catch (e) {}
                    }
                    if (!finalConfig) finalConfig = JSON.parse(localStorage.getItem(`${appId}_firebase_config`));
                    if (!finalConfig && HARDCODED_CONFIG.apiKey !== 'demo') finalConfig = HARDCODED_CONFIG;

                    if (finalConfig && finalConfig.apiKey !== 'demo') {
                        try {
                            const firebaseApp = getApps().length === 0 ? initializeApp(finalConfig) : getApp();
                            window.auth = getAuth(firebaseApp);
                            window.db = getFirestore(firebaseApp);
                            
                            onAuthStateChanged(window.auth, async (user) => {
                                document.getElementById('globalLoader').classList.add('hidden');
                                if (user) {
                                    if(user.isAnonymous) { await signOut(window.auth); return; }
                                    window.currentUser = user;
                                    const userDoc = await getDoc(doc(window.db, "users", user.uid));
                                    if(userDoc.exists()) {
                                        window.app.state.userRole = userDoc.data().role || 'initiator';
                                        document.getElementById('nav-user-info').innerText = `${userDoc.data().username}`;
                                    } else {
                                        const username = user.email ? user.email.split('@')[0] : 'user';
                                        const role = username === 'admin' ? 'admin' : 'initiator';
                                        await setDoc(doc(window.db, "users", user.uid), { username, role, uid: user.uid });
                                        window.app.state.userRole = role;
                                        document.getElementById('nav-user-info').innerText = username;
                                    }
                                    document.getElementById('nav-user-info').classList.remove('hidden');
                                    document.getElementById('btn-logout').classList.remove('hidden');
                                    if(window.app.state.userRole === 'admin') document.getElementById('btn-admin-panel').classList.remove('hidden');

                                    const orderId = new URLSearchParams(window.location.search).get('orderId');
                                    if (orderId) window.app.router.go('order-menu', { orderId });
                                    else window.app.router.go('home');
                                    window.app.store.loadAll();
                                } else {
                                    window.currentUser = null;
                                    const orderId = new URLSearchParams(window.location.search).get('orderId');
                                    if(orderId) window.app.router.go('login'); 
                                    else window.app.router.go('login');
                                }
                            });
                            window.app.config.checkApiKeyValidity();
                        } catch (err) {
                            console.error("Firebase Init Failed:", err);
                            alert("Firebase é€£ç·šå¤±æ•—");
                            window.app.ui.showConfigModal();
                            document.getElementById('globalLoader').classList.add('hidden');
                        }
                    } else {
                        document.getElementById('globalLoader').classList.add('hidden');
                        window.app.ui.showConfigModal();
                    }
                },
                save: () => {
                    const text = document.getElementById('config-input').value;
                    const regex = /(apiKey|authDomain|projectId|storageBucket|messagingSenderId|appId)\s*[:=]\s*['"]?([^'"\s,]+)['"]?/g;
                    let match; const config = {}; let count = 0;
                    while ((match = regex.exec(text)) !== null) { config[match[1]] = match[2]; count++; }
                    const newBaseUrl = document.getElementById('config-base-url').value.trim();
                    if(newBaseUrl) { localStorage.setItem(`${appId}_base_url`, newBaseUrl); window.app.state.baseUrl = newBaseUrl; }
                    else { const current = window.location.origin + window.location.pathname; localStorage.setItem(`${appId}_base_url`, current); window.app.state.baseUrl = current; }
                    if (count >= 6) {
                        localStorage.setItem(`${appId}_firebase_config`, JSON.stringify(config));
                        const aiMode = document.getElementById('btn-ai-custom').classList.contains('bg-primary') ? 'custom' : 'default';
                        localStorage.setItem(`${appId}_ai_mode`, aiMode);
                        if (aiMode === 'custom') {
                            const newKey = document.getElementById('custom-ai-key').value;
                            if(newKey) {
                                localStorage.setItem(`${appId}_ai_key`, newKey);
                                localStorage.setItem(`${appId}_ai_key_timestamp`, Date.now()); 
                            }
                        }
                        window.location.reload();
                    } else {
                        if(HARDCODED_CONFIG.apiKey !== 'demo') { localStorage.removeItem(`${appId}_firebase_config`); window.location.reload(); } else { alert("è¨­å®šæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰ 6 å€‹æ¬„ä½"); }
                    }
                },
                saveFromHome: () => {
                    const key = document.getElementById('home-api-key-input').value.trim();
                    if(!key) return alert("è«‹è¼¸å…¥ API Key");
                    localStorage.setItem(`${appId}_ai_mode`, 'custom');
                    localStorage.setItem(`${appId}_ai_key`, key);
                    localStorage.setItem(`${appId}_ai_key_timestamp`, Date.now());
                    alert("API Key å·²å„²å­˜ï¼Œæ•ˆæœŸ 30 å¤©ã€‚");
                    window.location.reload();
                },
                checkApiKeyValidity: () => {
                    const mode = localStorage.getItem(`${appId}_ai_mode`);
                    const key = localStorage.getItem(`${appId}_ai_key`);
                    const timestamp = parseInt(localStorage.getItem(`${appId}_ai_key_timestamp`) || "0");
                    const EXPIRY_MS = 30 * 24 * 60 * 60 * 1000;
                    let isValid = false;
                    
                    if (mode === 'custom') {
                        if (key) {
                            if (Date.now() - timestamp > EXPIRY_MS) {
                                localStorage.removeItem(`${appId}_ai_key`);
                                localStorage.removeItem(`${appId}_ai_key_timestamp`);
                                document.getElementById('api-key-msg-title').innerText = "AI é‡‘é‘°å·²éæœŸ (30å¤©)";
                                isValid = false;
                            } else { isValid = true; }
                        } else { isValid = false; }
                    }
                    if (!isValid) document.getElementById('api-key-alert').classList.remove('hidden');
                    else document.getElementById('api-key-alert').classList.add('hidden');
                },
                setAiMode: (mode) => {
                    if (mode === 'default') {
                        document.getElementById('btn-ai-default').className = 'flex-1 py-2 text-xs rounded-lg border border-primary bg-primary text-white font-bold';
                        document.getElementById('btn-ai-custom').className = 'flex-1 py-2 text-xs rounded-lg border border-gray-200 text-gray-400 font-bold';
                        document.getElementById('custom-ai-key').classList.add('hidden');
                    } else {
                        document.getElementById('btn-ai-default').className = 'flex-1 py-2 text-xs rounded-lg border border-gray-200 text-gray-400 font-bold';
                        document.getElementById('btn-ai-custom').className = 'flex-1 py-2 text-xs rounded-lg border border-primary bg-primary text-white font-bold';
                        document.getElementById('custom-ai-key').classList.remove('hidden');
                    }
                },
                generateShareUrl: () => {
                    const stored = localStorage.getItem(`${appId}_firebase_config`) || JSON.stringify(HARDCODED_CONFIG);
                    const url = `${window.app.state.baseUrl}?config=${btoa(stored)}`;
                    document.getElementById('config-share-result').classList.remove('hidden');
                    document.getElementById('config-share-url').value = url;
                    document.getElementById('config-qrcode').innerHTML = "";
                    new QRCode(document.getElementById('config-qrcode'), { text: url, width: 128, height: 128 });
                }
            },
            
            auth: {
                toggleLoginMode: () => {
                    window.app.state.isAdminLoginMode = !window.app.state.isAdminLoginMode;
                    const container = document.getElementById('login-username-container');
                    const title = document.getElementById('login-title');
                    const subtitle = document.getElementById('login-subtitle');
                    const hint = document.getElementById('login-hint');
                    const toggleBtn = document.getElementById('btn-toggle-login');
                    
                    if (window.app.state.isAdminLoginMode) {
                        container.classList.add('hidden');
                        title.innerText = "ç®¡ç†å“¡ç™»å…¥ ğŸ›¡ï¸";
                        subtitle.innerText = "è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼";
                        hint.innerText = "* é è¨­å¯†ç¢¼: admin123";
                        toggleBtn.innerText = "æˆ‘æ˜¯ä¸»æª (ä¸€èˆ¬ç™»å…¥)";
                    } else {
                        container.classList.remove('hidden');
                        title.innerText = "æ­¡è¿ä½¿ç”¨ ğŸ½ï¸";
                        subtitle.innerText = "è¨‚é¤ä¸»æªä½¿ç”¨è€…ç™»å…¥";
                        hint.innerText = "* è«‹ä½¿ç”¨ç®¡ç†è€…ç™¼é€çš„å¸³è™Ÿ";
                        toggleBtn.innerText = "æˆ‘æ˜¯ç®¡ç†å“¡";
                    }
                },
                login: async (e) => {
                    e.preventDefault();
                    let username = "";
                    let password = "";

                    if (window.app.state.isAdminLoginMode) {
                        username = "admin";
                        password = document.getElementById('login-password').value.trim();
                    } else {
                        username = document.getElementById('login-username').value.trim();
                        password = document.getElementById('login-password').value.trim();
                    }
                    const email = `${username}@food.app`; 
                    
                    if (password.length < 6) return alert("å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ç¢¼ (Firebase å®‰å…¨é™åˆ¶)");

                    try {
                        await signInWithEmailAndPassword(window.auth, email, password);
                    } catch (error) {
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                            if (!window.app.state.isAdminLoginMode) {
                                alert("å¸³è™Ÿä¸å­˜åœ¨æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚è«‹è¯ç¹«ç®¡ç†å“¡å»ºç«‹å¸³è™Ÿã€‚");
                            } else {
                                // Admin mode: try register if not exists (first time setup)
                                if (username === 'admin' && password === 'admin123') {
                                     try {
                                        const cred = await createUserWithEmailAndPassword(window.auth, email, password);
                                        await setDoc(doc(window.db, "users", cred.user.uid), { username: 'admin', role: 'admin', uid: cred.user.uid, createdAt: serverTimestamp() });
                                        alert("ç®¡ç†å“¡å¸³è™Ÿåˆå§‹åŒ–æˆåŠŸï¼è«‹å‹™å¿…ä¿®æ”¹å¯†ç¢¼ã€‚");
                                     } catch (regError) { 
                                         if(regError.code === 'auth/email-already-in-use') {
                                             alert("å¯†ç¢¼éŒ¯èª¤");
                                         } else if(regError.code === 'auth/operation-not-allowed') {
                                             alert("éŒ¯èª¤ï¼šè«‹è‡³ Firebase Console é–‹å•Ÿ 'Email/Password' ç™»å…¥åŠŸèƒ½ï¼");
                                         } else {
                                            alert("ç™»å…¥å¤±æ•—: " + regError.message); 
                                         }
                                     }
                                } else {
                                    alert("å¯†ç¢¼éŒ¯èª¤");
                                }
                            }
                        } else if(error.code === 'auth/operation-not-allowed') {
                            alert("éŒ¯èª¤ï¼šè«‹è‡³ Firebase Console é–‹å•Ÿ 'Email/Password' ç™»å…¥åŠŸèƒ½ï¼");
                        } else { alert("ç™»å…¥å¤±æ•—: " + error.message); }
                    }
                },
                logout: async () => {
                    await signOut(window.auth);
                    document.getElementById('nav-user-info').classList.add('hidden');
                    document.getElementById('btn-logout').classList.add('hidden');
                    document.getElementById('btn-admin-panel').classList.add('hidden');
                    window.app.router.go('login');
                },
                changePassword: async (e) => {
                    e.preventDefault();
                    const newPass = document.getElementById('new-password').value;
                    const confirmPass = document.getElementById('confirm-password').value;
                    
                    if (newPass !== confirmPass) return alert("å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´");
                    if (newPass.length < 6) return alert("å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ç¢¼");
                    
                    try {
                        await updatePassword(window.currentUser, newPass);
                        alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥");
                        window.app.ui.closeModal('modal-change-password');
                        window.app.auth.logout();
                    } catch (error) {
                        alert("ä¿®æ”¹å¤±æ•— (å¯èƒ½éœ€é‡æ–°ç™»å…¥å¾Œå†è©¦): " + error.message);
                    }
                }
            },

            // 6. Admin Actions
            admin: {
                showChangePasswordModal: () => {
                    document.getElementById('modal-change-password').classList.remove('hidden');
                    document.getElementById('modal-change-password').classList.add('flex');
                },
                showCreateUserModal: () => {
                    document.getElementById('modal-create-user').classList.remove('hidden');
                    document.getElementById('modal-create-user').classList.add('flex');
                },
                createUser: async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('new-user-name').value.trim();
                    const password = document.getElementById('new-user-pass').value.trim();
                    const role = document.getElementById('new-user-role').value;
                    const email = `${username}@food.app`;
                    
                    if(password.length < 6) return alert("å¯†ç¢¼éœ€è‡³å°‘6ç¢¼");

                    // Use Secondary App to create user without logging out Admin
                    let config = HARDCODED_CONFIG;
                    if (config.apiKey === 'demo') config = JSON.parse(localStorage.getItem('food-ordering-app_firebase_config'));
                    
                    try {
                        const secondaryApp = initializeApp(config, "Secondary");
                        const secondaryAuth = getAuth(secondaryApp);
                        const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                        
                        await setDoc(doc(window.db, "users", cred.user.uid), {
                            username, role, uid: cred.user.uid, createdAt: serverTimestamp()
                        });
                        
                        await signOut(secondaryAuth);
                        await deleteApp(secondaryApp); // Cleanup
                        
                        alert(`ä½¿ç”¨è€… ${username} å»ºç«‹æˆåŠŸï¼`);
                        window.app.ui.closeModal('modal-create-user');
                        window.app.admin.loadAllData(); // Refresh list
                    } catch(err) {
                        alert("å»ºç«‹å¤±æ•—: " + err.message);
                    }
                },
                loadAllData: async () => {
                    const qStores = query(collection(window.db, "stores"), orderBy("createdAt", "desc"));
                    const sSnap = await getDocs(qStores);
                    window.app.state.allStoresAdmin = sSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    const qUsers = query(collection(window.db, "users"));
                    const uSnap = await getDocs(qUsers);
                    window.app.state.allUsers = uSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    const container = document.getElementById('admin-all-stores-list');
                    container.innerHTML = window.app.state.allStoresAdmin.map(s => {
                        const owner = window.app.state.allUsers.find(u => u.uid === s.ownerId)?.username || '<span class="text-red-400">ç„¡ä¸»/èˆŠè³‡æ–™</span>';
                        const isMine = s.ownerId === window.currentUser.uid;
                        
                        return `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                            <div>
                                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                    ${s.name}
                                    ${isMine ? '<span class="text-[10px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded">æˆ‘çš„</span>' : ''}
                                </h3>
                                <p class="text-xs text-gray-400">Owner: ${owner} | ${s.menu ? s.menu.length : 0} é¡åˆ¥</p>
                            </div>
                            <div class="flex gap-2">
                                ${!isMine ? `<button onclick="window.app.admin.claimStore('${s.id}')" class="text-xs bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg font-bold hover:bg-orange-200">â• æ­¸æˆ¶</button>` : ''}
                                <button onclick="window.app.store.viewDetail('${s.id}')" class="text-xs bg-gray-100 px-3 py-1.5 rounded-lg font-bold text-gray-600 hover:bg-gray-200">æŸ¥çœ‹</button>
                                <button onclick="window.app.admin.showAssignModal('${s.id}')" class="text-xs bg-primary text-white px-3 py-1.5 rounded-lg font-bold hover:bg-primaryDark">è¤‡è£½çµ¦...</button>
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    // Render Users
                    const userContainer = document.getElementById('admin-user-list');
                    userContainer.innerHTML = window.app.state.allUsers.map(u => `
                        <div class="flex justify-between items-center p-2 border-b border-indigo-100 last:border-0">
                            <div><span class="font-bold">${u.username}</span> <span class="text-xs bg-indigo-200 px-1 rounded">${u.role}</span></div>
                            <span class="text-xs text-indigo-400 font-mono">${u.uid.substring(0,4)}...</span>
                        </div>
                    `).join('');
                },
                claimStore: async (storeId) => {
                    if(!confirm("ç¢ºå®šè¦å°‡æ­¤åº—å®¶æ­¸æˆ¶åˆ°æ‚¨çš„åä¸‹å—ï¼Ÿ")) return;
                    try {
                        await updateDoc(doc(window.db, "stores", storeId), {
                            ownerId: window.currentUser.uid,
                            updatedAt: serverTimestamp()
                        });
                        alert("æ­¸æˆ¶æˆåŠŸï¼ç¾åœ¨æ‚¨å¯ä»¥åœ¨ã€Œæˆ‘çš„åº—å®¶ã€ä¸­ç®¡ç†å®ƒäº†ã€‚");
                        window.app.admin.loadAllData(); // Reload list
                    } catch(e) {
                        alert("æ­¸æˆ¶å¤±æ•—: " + e.message);
                    }
                },
                showAssignModal: (storeId) => {
                    document.getElementById('assign-store-id').value = storeId;
                    const container = document.getElementById('assign-user-list');
                    container.innerHTML = window.app.state.allUsers.map(u => `
                        <div onclick="window.app.admin.confirmAssign('${u.uid}')" class="p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-primary/10 hover:border-primary border border-transparent transition flex justify-between items-center">
                            <span class="font-bold text-gray-700">${u.username}</span>
                            <span class="text-xs text-gray-400">${u.role}</span>
                        </div>
                    `).join('');
                    document.getElementById('modal-assign-store').classList.remove('hidden');
                    document.getElementById('modal-assign-store').classList.add('flex');
                },
                confirmAssign: async (targetUid) => {
                    if(!confirm("ç¢ºå®šè¦è¤‡è£½æ­¤åº—å®¶çµ¦è©²ä½¿ç”¨è€…å—ï¼Ÿ")) return;
                    const storeId = document.getElementById('assign-store-id').value;
                    const originalStore = window.app.state.allStoresAdmin.find(s => s.id === storeId);
                    
                    // Clone store data
                    const newStoreData = { ...originalStore };
                    delete newStoreData.id; // Remove original ID
                    newStoreData.ownerId = targetUid;
                    newStoreData.createdAt = serverTimestamp();
                    newStoreData.updatedAt = serverTimestamp();
                    
                    try {
                        await addDoc(collection(window.db, "stores"), newStoreData);
                        alert("åº—å®¶è¤‡è£½æˆåŠŸï¼");
                        window.app.ui.closeModal('modal-assign-store');
                    } catch(e) {
                        alert("è¤‡è£½å¤±æ•—: " + e.message);
                    }
                },
                renderStats: () => { const parts = window.app.admin.currentParticipants; document.getElementById('admin-total-amount').innerText = `$${parts.reduce((sum, p) => sum + p.total, 0)}`; document.getElementById('admin-total-count').innerText = `${parts.length} äºº`; },
                switchTab: (tab) => {
                    const btnItems = document.getElementById('tab-items'); const btnPeople = document.getElementById('tab-people'); const container = document.getElementById('admin-list-container');
                    if (tab === 'items') {
                        btnItems.className = "flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-primary shadow-sm ring-1 ring-gray-100 transition-all"; btnPeople.className = "flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-600 transition-all";
                        const agg = {};
                        window.app.admin.currentParticipants.forEach(p => { p.items.forEach(i => { const key = i.name + (i.variantsText ? ` [${i.variantsText}]` : ''); if (!agg[key]) agg[key] = { qty: 0, total: 0 }; agg[key].qty += i.qty; agg[key].total += i.fullPrice; }); });
                        let html = '<table class="w-full text-sm text-left"><tr class="text-gray-400 border-b border-gray-100"><th class="pb-2 pl-2">å“é … (è¦æ ¼)</th><th class="pb-2 text-right">æ•¸é‡</th><th class="pb-2 text-right pr-2">å°è¨ˆ</th></tr>';
                        for (let key in agg) { html += `<tr class="border-b border-gray-50 last:border-0"><td class="py-3 pl-2 text-xs font-bold text-textMain">${key}</td><td class="text-right font-bold text-gray-500">${agg[key].qty}</td><td class="text-right pr-2 font-bold text-primary">$${agg[key].total}</td></tr>`; } html += '</table>'; container.innerHTML = html;
                    } else {
                        btnItems.className = "flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-600 transition-all"; btnPeople.className = "flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-primary shadow-sm ring-1 ring-gray-100 transition-all";
                        let html = '<div class="space-y-3">';
                        window.app.admin.currentParticipants.forEach(p => { const itemsStr = p.items.map(i => `<span class="bg-gray-100 px-1.5 rounded text-[10px] mr-1">${i.name} ${i.variantsText} x${i.qty}</span>`).join(''); html += `<div class="flex justify-between items-start bg-white p-3 rounded-2xl border border-gray-50 hover:border-secondary/30 transition"><div><p class="font-bold text-textMain text-sm">${p.name} <span class="text-xs text-primary font-normal bg-secondary/10 px-1 rounded ml-1">${p.note || ''}</span></p><div class="mt-2 flex flex-wrap gap-1">${itemsStr}</div></div><span class="font-bold text-primary">$${p.total}</span></div>`; }); html += '</div>'; container.innerHTML = html;
                    }
                },
                exportCSV: () => {
                    const parts = window.app.admin.currentParticipants; if (parts.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
                    let phoneText = ""; const pEl = document.getElementById('admin-store-phone'); if(pEl && !pEl.classList.contains('hidden')) { phoneText = pEl.querySelector('span').innerText.replace('åº—å®¶é›»è©±: ', '') || ''; }
                    let csv = `\uFEFFåº—å®¶é›»è©±:${phoneText}\nè¨‚è³¼äºº,å“é …å…§å®¹,å‚™è¨»,ç¸½é‡‘é¡,ä¸‹å–®æ™‚é–“\n`;
                    parts.forEach(p => { const itemsStr = p.items.map(i => `${i.name} ${i.variantsText} x${i.qty}`).join('; '); const time = p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleString() : ''; csv += `"${p.name}","${itemsStr}","${p.note || ''}",${p.total},"${time}"\n`; });
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `åœ˜è³¼è¨‚å–®_${new Date().toISOString().slice(0,10)}.csv`; link.click();
                },
                init: async (orderId) => {
                    if (!window.db) return window.app.ui.showConfigModal();
                    const docSnap = await getDoc(doc(window.db, "orders", orderId));
                    if (!docSnap.exists()) return alert("Error");
                    const orderData = docSnap.data();
                    document.getElementById('admin-title').innerText = orderData.title;
                    document.getElementById('admin-order-id').innerText = orderId.substring(0,6);
                    if(orderData.storePhone) { const pEl = document.getElementById('admin-store-phone'); pEl.classList.remove('hidden'); pEl.querySelector('span').innerText = `åº—å®¶é›»è©±: ${orderData.storePhone}`; pEl.onclick = () => window.location.href = `tel:${orderData.storePhone}`; } else { document.getElementById('admin-store-phone').classList.add('hidden'); }
                    const shareUrl = `${window.app.state.baseUrl}?orderId=${orderId}`;
                    document.getElementById('share-link-input').value = shareUrl;
                    document.getElementById('qrcode-container').innerHTML = "";
                    new QRCode(document.getElementById('qrcode-container'), { text: shareUrl, width: 128, height: 128 });
                    onSnapshot(query(collection(window.db, "orders", orderId, "participants"), orderBy("createdAt", "desc")), (snapshot) => { window.app.admin.currentParticipants = snapshot.docs.map(d => d.data()); window.app.admin.renderStats(); window.app.admin.switchTab('items'); });
                }
            },

            // 7. Store Module
            store: {
                loadAll: async () => {
                    if (!window.db || !window.currentUser) return;
                    // Filter stores by ownerId
                    const q = query(collection(window.db, "stores"), where("ownerId", "==", window.currentUser.uid), orderBy("createdAt", "desc"));
                    const snapshot = await getDocs(q);
                    window.app.state.stores = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                },
                save: async (e) => {
                    e.preventDefault();
                    if (!window.db) return window.app.ui.showConfigModal();
                    
                    const form = e.target;
                    const storeId = document.getElementById('edit-store-id').value;
                    const name = form.storeName.value;
                    const category = form.category.value;
                    const phone = form.phone.value;
                    const orderLink = form.orderLink.value;
                    const isDrinkStore = document.getElementById('is-drink-store').checked;
                    const menu = []; const toppings = [];
                    document.querySelectorAll('.category-block').forEach(catEl => {
                        const catName = catEl.querySelector('.category-name').value.trim();
                        if(!catName) return;
                        const items = [];
                        catEl.querySelectorAll('.menu-item-row').forEach(row => { const n = row.querySelector('.item-name').value.trim(); const pStr = row.querySelector('.item-price').value.trim(); if(n && pStr) items.push({ name: n, priceStr: pStr }); });
                        if(items.length > 0) menu.push({ category: catName, items });
                    });
                    document.querySelectorAll('.topping-item-row').forEach(row => { const n = row.querySelector('.topping-name').value.trim(); const p = row.querySelector('.topping-price').value.trim(); if(n && p) toppings.push({ name: n, price: parseInt(p) }); });
                    let imageBase64 = null;
                    const fileInput = document.getElementById('menu-image-upload');
                    if (fileInput.files[0]) imageBase64 = await window.app.utils.resizeImage(fileInput.files[0]);
                    const data = { name, category, phone, orderLink, isDrinkStore, menu, toppings, updatedAt: serverTimestamp(), ownerId: window.currentUser.uid };
                    if(imageBase64) data.image = imageBase64;
                    try {
                        if(storeId) { await updateDoc(doc(window.db, "stores", storeId), data); alert("åº—å®¶è³‡æ–™å·²æ›´æ–°ï¼"); }
                        else { data.createdAt = serverTimestamp(); await addDoc(collection(window.db, "stores"), data); alert("åº—å®¶æ–°å¢æˆåŠŸï¼ğŸ‰"); }
                        window.app.ui.closeModal('modal-add-store'); await window.app.store.loadAll();
                        if(storeId) window.app.store.viewDetail(storeId); else window.app.router.go('store-manage');
                    } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
                },
                // ... showAddModal, resetUpload, skipToForm, addCategory, addItemToCategory, addTopping, viewDetail, updateStoreData, deleteMenuItem, deleteToppingItem, editMenuItem, editToppingItem, saveSingleItem, quickAddMode, confirmQuickAdd, retakePhoto, deleteStore, renderList, renderSelectOptions ...
                showAddModal: (isRetake=false) => {
                     document.querySelector('#modal-add-store form').reset();
                     document.getElementById('menu-editor-container').innerHTML = '';
                     document.getElementById('toppings-editor-container').innerHTML = '<div class="text-center py-2 text-xs text-gray-400" id="no-toppings-msg">å°šç„¡åŠ æ–™é¸é …</div>';
                     document.getElementById('edit-store-id').value = '';
                     document.getElementById('img-preview').src = '';
                     document.getElementById('image-preview-area').classList.add('hidden');
                     document.getElementById('ai-success-msg').classList.add('hidden');
                     document.getElementById('store-initial-upload').classList.remove('hidden');
                     document.getElementById('store-form-details').classList.add('hidden');
                     if(isRetake && window.app.state.viewingStoreId) {
                         const store = window.app.state.stores.find(s=>s.id===window.app.state.viewingStoreId);
                         if(store) {
                             document.querySelector('[name="storeName"]').value = store.name;
                             document.querySelector('[name="category"]').value = store.category || '';
                             document.querySelector('[name="phone"]').value = store.phone || '';
                             document.querySelector('[name="orderLink"]').value = store.orderLink || '';
                             document.getElementById('is-drink-store').checked = store.isDrinkStore || false;
                             document.getElementById('edit-store-id').value = store.id;
                             if(store.menu) store.menu.forEach(cat => { window.app.store.addCategory(cat.category); const lastCat = document.getElementById('menu-editor-container').lastElementChild; cat.items.forEach(i => window.app.store.addItemToCategory(lastCat.dataset.id, i.name, i.priceStr)); });
                             if(store.toppings) { const msg = document.getElementById('no-toppings-msg'); if(msg) msg.remove(); store.toppings.forEach(t => window.app.store.addTopping(t.name, t.price)); }
                         }
                     }
                     document.getElementById('modal-add-store').classList.remove('hidden'); document.getElementById('modal-add-store').classList.add('flex');
                },
                resetUpload: () => { document.getElementById('store-initial-upload').classList.remove('hidden'); document.getElementById('store-form-details').classList.add('hidden'); },
                skipToForm: () => { document.getElementById('store-initial-upload').classList.add('hidden'); document.getElementById('store-form-details').classList.remove('hidden'); if(document.getElementById('menu-editor-container').children.length === 0) window.app.store.addCategory('ç†±é–€å•†å“'); },
                addCategory: (name = '') => {
                    const id = Date.now() + Math.random().toString(16).slice(2);
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-xl border border-gray-100 category-block relative group mb-3 shadow-sm";
                    div.dataset.id = id;
                    div.innerHTML = `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-50"><i class="fa-solid fa-layer-group text-primary"></i><input type="text" placeholder="åˆ†é¡åç¨±" value="${name}" class="category-name flex-1 font-bold bg-transparent border-none focus:ring-0 outline-none py-1 text-sm text-textMain"><button type="button" onclick="this.closest('.category-block').remove()" class="text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button></div><div class="space-y-2 item-list pl-2"></div><button type="button" onclick="window.app.store.addItemToCategory('${id}')" class="mt-2 text-xs text-primary font-bold hover:bg-secondary/20 px-3 py-1.5 rounded-full transition">+ æ–°å¢å“é …</button>`;
                    document.getElementById('menu-editor-container').appendChild(div);
                    if(!name) window.app.store.addItemToCategory(id);
                },
                addItemToCategory: (catId, name='', priceStr='') => {
                    const catBlock = document.querySelector(`.category-block[data-id="${catId}"] .item-list`);
                    if(!catBlock) return;
                    const div = document.createElement('div');
                    div.className = "flex gap-2 items-center menu-item-row";
                    div.innerHTML = `<input type="text" placeholder="å“å" value="${name}" class="item-name w-3/5 p-2 bg-gray-50 rounded-lg text-sm focus:bg-white focus:ring-1 focus:ring-primary outline-none font-medium"><input type="text" placeholder="$" value="${priceStr}" class="item-price w-2/5 p-2 bg-gray-50 rounded-lg text-sm focus:bg-white focus:ring-1 focus:ring-primary outline-none font-medium"><button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-400 w-6"><i class="fa-solid fa-xmark"></i></button>`;
                    catBlock.appendChild(div);
                },
                addTopping: (name='', price='') => {
                    const container = document.getElementById('toppings-editor-container');
                    const msg = document.getElementById('no-toppings-msg'); if(msg) msg.remove();
                    const div = document.createElement('div');
                    div.className = "flex gap-2 items-center topping-item-row";
                    div.innerHTML = `<input type="text" placeholder="åŠ æ–™åç¨±" value="${name}" class="topping-name w-3/5 p-2 bg-white rounded-lg text-sm border border-gray-100 focus:border-primary outline-none"><input type="number" placeholder="$" value="${price}" class="topping-price w-2/5 p-2 bg-white rounded-lg text-sm border border-gray-100 focus:border-primary outline-none"><button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-400 w-6"><i class="fa-solid fa-xmark"></i></button>`;
                    container.appendChild(div);
                },
                viewDetail: (storeId) => {
                    let store = window.app.state.stores.find(s => s.id === storeId);
                    if (!store && window.app.state.userRole === 'admin') store = window.app.state.allStoresAdmin.find(s => s.id === storeId);
                    
                    if (!store) return;
                    window.app.state.viewingStoreId = storeId;
                    document.getElementById('detail-store-name').innerText = store.name;
                    document.getElementById('detail-store-icon').innerHTML = window.app.utils.getCategoryIcon(store.category);
                    
                    if (store.ownerId === window.currentUser.uid || window.app.state.userRole === 'admin') {
                         document.getElementById('store-owner-actions').classList.remove('hidden');
                    } else {
                         document.getElementById('store-owner-actions').classList.add('hidden');
                    }

                    const container = document.getElementById('detail-menu-container');
                    let menuToRender = store.menu || (store.items ? [{ category: 'ç²¾é¸å•†å“', items: store.items.map(i => ({name: i.name, priceStr: i.price.toString()})) }] : []);
                    const bgColors = ['bg-red-50', 'bg-orange-50', 'bg-amber-50', 'bg-yellow-50', 'bg-lime-50', 'bg-green-50', 'bg-emerald-50', 'bg-teal-50', 'bg-cyan-50', 'bg-sky-50', 'bg-blue-50', 'bg-indigo-50', 'bg-violet-50', 'bg-purple-50', 'bg-fuchsia-50', 'bg-pink-50', 'bg-rose-50'];
                    let html = '';
                    if (store.toppings && store.toppings.length > 0) {
                         html += `<div class="mb-8 p-4 bg-gray-50 rounded-[1.5rem] border border-gray-100"><h3 class="font-bold text-gray-600 mb-4 ml-2 text-lg flex items-center gap-2"><i class="fa-solid fa-cubes-stacked text-gray-400"></i> åŠ æ–™å€</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3">${store.toppings.map((t, idx) => `<div class="bg-white p-3 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm"><div><span class="font-bold text-sm text-gray-700 block">${t.name}</span><span class="text-xs font-extrabold text-red-500 bg-red-50 px-1.5 py-0.5 rounded ml-0 mt-1 inline-block border border-red-100">+$${t.price}</span></div><div class="flex gap-1"><button onclick="window.app.store.editToppingItem(${idx})" class="text-gray-300 hover:text-blue-500 w-6 h-6 flex items-center justify-center rounded hover:bg-blue-50 transition"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="window.app.store.deleteToppingItem(${idx})" class="text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded hover:bg-red-50 transition"><i class="fa-solid fa-trash text-xs"></i></button></div></div>`).join('')}</div></div>`;
                    }
                    if (!menuToRender || menuToRender.length === 0) { html += '<div class="text-center text-gray-400 py-10">å°šç„¡èœå–®è³‡æ–™</div>'; }
                    else {
                        html += menuToRender.map((cat, idx) => {
                            const bgClass = bgColors[idx % bgColors.length];
                            return `<div class="mb-6 p-4 rounded-[1.5rem] ${bgClass} border border-white/50 shadow-sm"><h3 class="font-bold text-gray-700 mb-4 ml-1 text-lg flex items-center gap-2"><span class="w-2 h-6 bg-white/50 rounded-full"></span> ${cat.category}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${cat.items.map((item, itemIdx) => `<div class="bg-white p-4 rounded-2xl shadow-sm border border-white/50 flex flex-col justify-between h-full hover:shadow-md transition relative group"><div><h4 class="font-bold text-gray-800 text-base line-clamp-2 leading-tight">${item.name}</h4><div class="mt-3">${window.app.utils.renderPriceTags(item.priceStr)}</div></div><div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 rounded-lg p-1 shadow-sm"><button onclick="window.app.store.editMenuItem(${idx}, ${itemIdx})" class="text-gray-400 hover:text-blue-500 w-7 h-7 flex items-center justify-center rounded hover:bg-blue-50 transition"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="window.app.store.deleteMenuItem(${idx}, ${itemIdx})" class="text-gray-400 hover:text-red-500 w-7 h-7 flex items-center justify-center rounded hover:bg-red-50 transition"><i class="fa-solid fa-trash text-xs"></i></button></div></div>`).join('')}</div></div>`;
                        }).join('');
                    }
                    container.innerHTML = html;
                    window.app.router.go('store-detail');
                },
                updateStoreData: async (storeId, newData) => { try { await updateDoc(doc(window.db, "stores", storeId), newData); const storeIdx = window.app.state.stores.findIndex(s => s.id === storeId); if (storeIdx > -1) { window.app.state.stores[storeIdx] = { ...window.app.state.stores[storeIdx], ...newData }; } return true; } catch (e) { alert("æ›´æ–°å¤±æ•—: " + e.message); return false; } },
                deleteMenuItem: async (catIdx, itemIdx) => { if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é¤é»å—ï¼Ÿ")) return; const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const newMenu = [...store.menu]; newMenu[catIdx].items.splice(itemIdx, 1); if (await window.app.store.updateStoreData(store.id, { menu: newMenu })) { window.app.store.viewDetail(store.id); } },
                deleteToppingItem: async (idx) => { if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é…æ–™å—ï¼Ÿ")) return; const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const newToppings = [...store.toppings]; newToppings.splice(idx, 1); if (await window.app.store.updateStoreData(store.id, { toppings: newToppings })) { window.app.store.viewDetail(store.id); } },
                editMenuItem: (catIdx, itemIdx) => { const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const item = store.menu[catIdx].items[itemIdx]; document.getElementById('edit-item-title').innerText = "ç·¨è¼¯é¤é»"; document.getElementById('edit-item-type').value = 'menu'; document.getElementById('edit-item-cat-idx').value = catIdx; document.getElementById('edit-item-idx').value = itemIdx; document.getElementById('edit-item-name').value = item.name; document.getElementById('edit-item-price').value = item.priceStr; document.getElementById('modal-edit-single-item').classList.remove('hidden'); document.getElementById('modal-edit-single-item').classList.add('flex'); },
                editToppingItem: (idx) => { const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const item = store.toppings[idx]; document.getElementById('edit-item-title').innerText = "ç·¨è¼¯é…æ–™"; document.getElementById('edit-item-type').value = 'topping'; document.getElementById('edit-item-idx').value = idx; document.getElementById('edit-item-name').value = item.name; document.getElementById('edit-item-price').value = item.price; document.getElementById('modal-edit-single-item').classList.remove('hidden'); document.getElementById('modal-edit-single-item').classList.add('flex'); },
                saveSingleItem: async (e) => {
                    e.preventDefault(); if (!confirm("ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ")) return;
                    const type = document.getElementById('edit-item-type').value; const name = document.getElementById('edit-item-name').value; const priceVal = document.getElementById('edit-item-price').value;
                    const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId);
                    if (type === 'menu') { const catIdx = parseInt(document.getElementById('edit-item-cat-idx').value); const itemIdx = parseInt(document.getElementById('edit-item-idx').value); const newMenu = [...store.menu]; newMenu[catIdx].items[itemIdx] = { name, priceStr: priceVal }; if (await window.app.store.updateStoreData(store.id, { menu: newMenu })) { window.app.ui.closeModal('modal-edit-single-item'); window.app.store.viewDetail(store.id); } }
                    else { const idx = parseInt(document.getElementById('edit-item-idx').value); const newToppings = [...store.toppings]; newToppings[idx] = { name, price: parseInt(priceVal) || 0 }; if (await window.app.store.updateStoreData(store.id, { toppings: newToppings })) { window.app.ui.closeModal('modal-edit-single-item'); window.app.store.viewDetail(store.id); } }
                },
                quickAddMode: () => { const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const sel = document.getElementById('quick-add-category'); sel.innerHTML = store.menu.map(c => `<option value="${c.category}">${c.category}</option>`).join(''); document.getElementById('modal-quick-add').classList.remove('hidden'); document.getElementById('modal-quick-add').classList.add('flex'); },
                confirmQuickAdd: async (e) => { e.preventDefault(); const catName = document.getElementById('quick-add-category').value; const name = document.getElementById('quick-add-name').value; const price = document.getElementById('quick-add-price').value; const store = window.app.state.stores.find(s => s.id === window.app.state.viewingStoreId) || window.app.state.allStoresAdmin.find(s => s.id === window.app.state.viewingStoreId); const newMenu = [...store.menu]; const catIndex = newMenu.findIndex(c => c.category === catName); if(catIndex > -1) { newMenu[catIndex].items.push({name, priceStr: price}); await updateDoc(doc(window.db, "stores", store.id), { menu: newMenu }); alert("å·²åŠ å…¥ï¼"); window.app.ui.closeModal('modal-quick-add'); document.getElementById('quick-add-name').value = ''; document.getElementById('quick-add-price').value = ''; if(window.app.state.userRole==='admin') window.app.admin.loadAllData(); else await window.app.store.loadAll(); window.app.store.viewDetail(store.id); } },
                retakePhoto: () => { window.app.store.showAddModal(true); },
                deleteStore: async () => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹åº—å®¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) { await deleteDoc(doc(window.db, "stores", window.app.state.viewingStoreId)); alert("åº—å®¶å·²åˆªé™¤"); if(window.app.state.userRole==='admin') { window.app.admin.loadAllData(); window.app.router.go('admin-panel'); } else { window.app.store.loadAll(); window.app.router.go('store-manage'); } } },
                renderList: () => {
                    const container = document.getElementById('store-list');
                    container.innerHTML = window.app.state.stores.map(s => {
                        const itemCount = s.menu ? s.menu.reduce((acc, c) => acc + c.items.length, 0) : (s.items ? s.items.length : 0);
                        return `<div onclick="window.app.store.viewDetail('${s.id}')" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-gray-100 flex justify-between items-center group hover:shadow-md transition cursor-pointer relative overflow-hidden"><div class="absolute -right-6 -top-6 w-24 h-24 bg-secondary/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div><div class="flex items-center gap-4 relative z-10"><div class="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-2xl shadow-sm border border-white">${window.app.utils.getCategoryIcon(s.category)}</div><div><h3 class="font-bold text-lg flex items-center gap-2 text-textMain">${s.name} ${s.category ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">${s.category}</span>` : ''}</h3><p class="text-xs text-gray-400 mt-1 pl-6">${itemCount} å€‹å“é … ${s.phone ? `â€¢ ğŸ“` : ''}</p></div></div><div class="text-right relative z-10"><span class="text-gray-300 text-sm group-hover:text-primary transition"><i class="fa-solid fa-chevron-right"></i></span></div></div>`;
                    }).join('');
                },
                renderSelectOptions: () => {
                    const sel = document.getElementById('create-order-store');
                    sel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>' + window.app.state.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                }
            },
            
            // ... order, ai, utils ... (Same as previous)
            order: {
                create: async (e) => {
                    e.preventDefault();
                    if (!window.db) return window.app.ui.showConfigModal();
                    const storeId = document.getElementById('create-order-store').value;
                    const title = document.getElementById('create-order-title').value;
                    const storeData = window.app.state.stores.find(s => s.id === storeId);
                    if (!storeId) return alert("è«‹é¸æ“‡åº—å®¶");
                    let finalMenu = storeData.menu || [{ category: 'ç²¾é¸å•†å“', items: storeData.items.map(i => ({name: i.name, priceStr: i.price.toString()})) }];
                    let toppings = storeData.toppings || [];
                    try {
                        const docRef = await addDoc(collection(window.db, "orders"), {
                            storeId, storeName: storeData.name, storePhone: storeData.phone || "", storeLink: storeData.orderLink || "", isDrinkStore: storeData.isDrinkStore || false, menu: finalMenu, toppings, title, hostId: window.currentUser.uid, createdAt: serverTimestamp(), status: 'active'
                        });
                        const history = JSON.parse(localStorage.getItem(`${appId}_my_orders`) || "[]");
                        history.push({ id: docRef.id, title, date: new Date().toISOString() });
                        localStorage.setItem(`${appId}_my_orders`, JSON.stringify(history));
                        window.app.router.go('admin-dashboard', { orderId: docRef.id });
                    } catch (err) { alert("é–‹åœ˜å¤±æ•—: " + err.message); }
                },
                loadHistory: () => {
                    const history = JSON.parse(localStorage.getItem(`${appId}_my_orders`) || "[]");
                    const container = document.getElementById('home-order-list');
                    if (history.length === 0) return;
                    container.innerHTML = history.reverse().map(o => `<div onclick="window.app.router.go('admin-dashboard', {orderId: '${o.id}'})" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-gray-100 cursor-pointer hover:bg-white hover:shadow-md transition group relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-2 bg-secondary"></div><h4 class="font-bold text-textMain text-lg">${o.title}</h4><p class="text-xs text-gray-400 mt-1 flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${new Date(o.date).toLocaleDateString()}</p><i class="fa-solid fa-chevron-right absolute right-5 top-1/2 -translate-y-1/2 text-gray-200 group-hover:text-primary transition"></i></div>`).join('');
                },
                initMenu: async (orderId) => {
                    if (!window.db) return window.app.ui.showConfigModal();
                    const docSnap = await getDoc(doc(window.db, "orders", orderId));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.app.state.currentOrder = { id: orderId, ...data };
                        document.getElementById('menu-order-title').innerText = data.title;
                        document.getElementById('menu-store-name').innerHTML = `${window.app.utils.getCategoryIcon(data.storeCategory)} ${data.storeName}`; 
                        const contactContainer = document.getElementById('menu-contact-actions');
                        if (data.storePhone || data.storeLink) {
                            contactContainer.classList.remove('hidden');
                            if(data.storePhone) document.getElementById('btn-call-store').href = `tel:${data.storePhone}`; else document.getElementById('btn-call-store').classList.add('hidden');
                            if(data.storeLink) document.getElementById('btn-open-store-link').href = data.storeLink; else document.getElementById('btn-open-store-link').classList.add('hidden');
                        } else { contactContainer.classList.add('hidden'); }
                        const nav = document.getElementById('menu-category-nav');
                        nav.innerHTML = data.menu.map((cat, idx) => `<a href="#cat-${idx}" class="whitespace-nowrap px-4 py-2 rounded-full bg-white border border-gray-100 text-sm font-bold text-gray-500 shadow-sm hover:text-primary hover:border-primary/30 active:scale-95 transition snap-center">${cat.category}</a>`).join('');
                        const container = document.getElementById('menu-items-container');
                        container.innerHTML = data.menu.map((cat, idx) => `<div id="cat-${idx}" class="scroll-mt-32"><h3 class="font-bold text-textMain mb-4 ml-2 text-lg flex items-center gap-2"><span class="w-1.5 h-6 bg-primary rounded-full"></span>${cat.category}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${cat.items.map((item, iIdx) => `<div onclick="window.app.order.openItemModal(${idx}, ${iIdx})" class="group bg-white p-4 rounded-[1.5rem] shadow-sm border-2 border-secondary/30 flex flex-col justify-between h-full transition-all duration-300 hover:-translate-y-1 hover:shadow-[0_8px_20px_-5px_rgba(255,154,162,0.3)] hover:border-primary/50 active:scale-95 cursor-pointer relative overflow-hidden"><div class="absolute -right-4 -top-4 w-16 h-16 bg-gradient-to-br from-secondary/40 to-primary/10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div><div class="relative z-10"><h4 class="font-bold text-textMain text-base line-clamp-2 leading-tight">${item.name}</h4><div class="mt-3 flex items-end justify-between gap-2"><div class="flex-1">${window.app.utils.renderPriceTags(item.priceStr)}</div><div class="w-8 h-8 bg-secondary/20 rounded-full flex-shrink-0 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors shadow-sm"><i class="fa-solid fa-plus text-xs"></i></div></div></div></div>`).join('')}</div></div>`).join('');
                        window.app.state.cart = []; window.app.order.renderCartTotal();
                    } else { alert("è¨‚å–®ä¸å­˜åœ¨"); window.app.router.go('home'); }
                },
                openItemModal: (catIdx, itemIdx) => {
                    const order = window.app.state.currentOrder;
                    const item = order.menu[catIdx].items[itemIdx];
                    const variants = window.app.utils.parsePriceVariants(item.priceStr);
                    window.app.state.tempItem = { name: item.name, baseVariants: variants, selectedVariant: variants[0], sugar: 'ç„¡ç³–', ice: 'å»å†°', qty: 1, selectedToppings: [] };
                    document.getElementById('detail-item-name').innerText = item.name;
                    document.getElementById('detail-qty').innerText = 1;
                    const container = document.getElementById('detail-options-container');
                    let html = '';
                    if (variants.length > 1 || (variants.length === 1 && variants[0].label !== 'å–®ä¸€è¦æ ¼')) {
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">å®¹é‡è¦æ ¼</p><div class="flex flex-wrap gap-2">${variants.map((v, idx) => `<button onclick="window.app.order.selectVariant(${idx})" class="variant-btn px-5 py-3 rounded-2xl border transition-all text-sm font-bold ${idx===0?'border-primary bg-primary text-white shadow-md shadow-primary/30':'border-gray-100 bg-gray-50 text-gray-500 hover:bg-gray-100'}" data-idx="${idx}">${v.label} <span class="ml-1 text-xs opacity-80">$${v.price}</span></button>`).join('')}</div></div>`;
                    }
                    if (order.isDrinkStore) {
                        const sugars = ['æ­£å¸¸ç³–','å°‘ç³–','åŠç³–','å¾®ç³–','ç„¡ç³–'];
                        const ices = ['æ­£å¸¸å†°','å°‘å†°','åŠå†°','å¾®å†°','å»å†°','æº«','ç†±'];
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">ç³–åº¦é¸æ“‡</p><div class="flex flex-wrap gap-2">${sugars.map(s => `<button onclick="window.app.order.selectOption('sugar', '${s}', this)" class="sugar-btn px-4 py-2 rounded-xl border transition-all text-xs font-bold ${s==='ç„¡ç³–'?'border-secondary bg-secondary text-primaryDark':'border-gray-100 bg-white text-gray-500 hover:bg-gray-50'}">${s}</button>`).join('')}</div></div>`;
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">å†°å¡Šé¸æ“‡</p><div class="flex flex-wrap gap-2">${ices.map(i => `<button onclick="window.app.order.selectOption('ice', '${i}', this)" class="ice-btn px-4 py-2 rounded-xl border transition-all text-xs font-bold ${i==='å»å†°'?'border-accent bg-accent text-teal-800':'border-gray-100 bg-white text-gray-500 hover:bg-gray-50'}">${i}</button>`).join('')}</div></div>`;
                    }
                    if (order.toppings && order.toppings.length > 0) {
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">åŠ æ–™å€</p><div class="flex flex-wrap gap-2">${order.toppings.map((t, idx) => `<button onclick="window.app.order.toggleTopping(${idx}, this)" class="topping-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold" data-price="${t.price}">${t.name} +$${t.price}</button>`).join('')}</div></div>`;
                    }
                    container.innerHTML = html;
                    window.app.order.updateDetailPrice();
                    document.getElementById('modal-item-detail').classList.remove('hidden'); document.getElementById('modal-item-detail').classList.add('flex');
                },
                selectVariant: (idx) => { window.app.state.tempItem.selectedVariant = window.app.state.tempItem.baseVariants[idx]; document.querySelectorAll('.variant-btn').forEach(b => b.className = 'variant-btn px-5 py-3 rounded-2xl border border-gray-100 bg-gray-50 text-gray-500 hover:bg-gray-100 transition-all text-sm font-bold'); document.querySelector(`.variant-btn[data-idx="${idx}"]`).className = 'variant-btn px-5 py-3 rounded-2xl border border-primary bg-primary text-white shadow-md shadow-primary/30 transition-all text-sm font-bold'; window.app.order.updateDetailPrice(); },
                selectOption: (type, val, btn) => { window.app.state.tempItem[type] = val; const cls = `.${type}-btn`; const activeClass = type === 'sugar' ? 'border-secondary bg-secondary text-primaryDark' : 'border-accent bg-accent text-teal-800'; document.querySelectorAll(cls).forEach(b => b.className = `${type}-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold`); btn.className = `${type}-btn px-4 py-2 rounded-xl border ${activeClass} transition-all text-xs font-bold`; },
                toggleTopping: (idx, btn) => {
                    const topping = window.app.state.currentOrder.toppings[idx];
                    const existsIdx = window.app.state.tempItem.selectedToppings.findIndex(t => t.name === topping.name);
                    if(existsIdx > -1) { window.app.state.tempItem.selectedToppings.splice(existsIdx, 1); btn.className = 'topping-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold'; }
                    else { window.app.state.tempItem.selectedToppings.push(topping); btn.className = 'topping-btn px-4 py-2 rounded-xl border border-primary/50 bg-primary/10 text-primary font-bold transition-all text-xs'; }
                    window.app.order.updateDetailPrice();
                },
                detailQty: (delta) => { let newQty = window.app.state.tempItem.qty + delta; if(newQty < 1) newQty = 1; window.app.state.tempItem.qty = newQty; document.getElementById('detail-qty').innerText = newQty; window.app.order.updateDetailPrice(); },
                updateDetailPrice: () => {
                    const base = window.app.state.tempItem.selectedVariant.price;
                    const toppings = window.app.state.tempItem.selectedToppings.reduce((sum, t) => sum + t.price, 0);
                    const total = (base + toppings) * window.app.state.tempItem.qty;
                    document.getElementById('detail-base-price').innerText = `$${base}`;
                    if(toppings > 0) document.getElementById('detail-base-price').innerText += ` (+${toppings})`;
                    document.getElementById('detail-add-price').innerText = `$${total}`;
                },
                addToCartFromDetail: () => {
                    const t = window.app.state.tempItem;
                    let variantsText = "";
                    if (t.baseVariants.length > 1 || t.baseVariants[0].label !== 'å–®ä¸€è¦æ ¼') variantsText += t.selectedVariant.label;
                    if (window.app.state.currentOrder.isDrinkStore) variantsText += ` (${t.sugar}/${t.ice})`;
                    if (t.selectedToppings.length > 0) variantsText += ` +${t.selectedToppings.map(tp=>tp.name).join(',')}`;
                    const toppingsPrice = t.selectedToppings.reduce((sum, tp) => sum + tp.price, 0);
                    const unitPrice = t.selectedVariant.price + toppingsPrice;
                    window.app.state.cart.push({ id: Date.now(), name: t.name, price: unitPrice, qty: t.qty, variantsText: variantsText, fullPrice: unitPrice * t.qty });
                    window.app.ui.closeModal('modal-item-detail'); window.app.order.renderCartTotal();
                },
                renderCartTotal: () => { const total = window.app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0); const count = window.app.state.cart.reduce((sum, i) => sum + i.qty, 0); document.getElementById('cart-total-price').innerText = `$${total}`; document.getElementById('cart-count').innerText = count; },
                showSubmitModal: () => { window.app.order.showCartModal(); document.getElementById('modal-submit-order').classList.remove('hidden'); document.getElementById('modal-submit-order').classList.add('flex'); document.getElementById('participant-name').focus(); },
                showCartModal: () => { const summary = document.getElementById('cart-summary'); if(window.app.state.cart.length === 0) { summary.innerHTML = '<p class="text-center text-gray-400 py-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ ğŸ›’</p>'; document.getElementById('final-total').innerText = '$0'; return; } summary.innerHTML = window.app.state.cart.map((i, idx) => `<div class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0"><div><div class="font-bold text-gray-800">${i.name} <span class="text-primary">x${i.qty}</span></div><div class="text-[10px] text-gray-400 mt-0.5">${i.variantsText}</div></div><div class="flex items-center gap-3"><span class="font-bold text-gray-600">$${i.fullPrice}</span><button onclick="window.app.order.removeFromCart(${idx})" class="text-gray-300 hover:text-red-400 text-xs w-5 h-5 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); const total = window.app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0); document.getElementById('final-total').innerText = `$${total}`; },
                removeFromCart: (idx) => { window.app.state.cart.splice(idx, 1); window.app.order.showCartModal(); window.app.order.renderCartTotal(); },
                submit: async (e) => { e.preventDefault(); if(window.app.state.cart.length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); const name = document.getElementById('participant-name').value; const note = document.getElementById('participant-note').value; try { await addDoc(collection(window.db, "orders", window.app.state.currentOrder.id, "participants"), { name, note, items: window.app.state.cart, total: window.app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0), createdAt: serverTimestamp() }); alert("è¨‚è³¼æˆåŠŸï¼ğŸ‰"); window.app.ui.closeModal('modal-submit-order'); window.app.state.cart = []; window.app.order.renderCartTotal(); document.getElementById('participant-name').value = ''; document.getElementById('participant-note').value = ''; } catch (err) { alert("é€å‡ºå¤±æ•—: " + err.message); } }
            },

            ai: {
                scanMenu: async () => {
                    const fileInput = document.getElementById('menu-image-upload');
                    const statusEl = document.getElementById('scan-status');
                    
                    if (!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡");
                    
                    const mode = localStorage.getItem(`${appId}_ai_mode`) || 'default';
                    let apiKey = "";
                    if (mode === 'custom') { apiKey = localStorage.getItem(`${appId}_ai_key`); if (!apiKey) return alert("è‡ªè¨‚æ¨¡å¼è«‹å…ˆè¼¸å…¥ Key"); }

                    if(statusEl) statusEl.innerText = "ğŸ¤– AI æ­£åœ¨åˆ†æèœå–®åœ–ç‰‡...";
                    
                    try {
                        const base64Image = (await window.app.utils.fileToBase64(fileInput.files[0])).split(',')[1];
                        const prompt = `
                            Analyze this menu image. Return a JSON structure.
                            Format: {
                                "storeName": "Name extracted from menu",
                                "category": "Suggested category e.g. é¤é£Ÿ, é£²æ–™, etc.",
                                "phone": "extracted phone",
                                "orderLink": "extracted url",
                                "isDrinkStore": true/false (true if menu has sugar/ice levels or mostly drinks),
                                "menu": [{ "category": "Category Name", "items": [{ "name": "Item Name", "priceStr": "Price String" }] }],
                                "toppings": [{ "name": "Topping Name", "price": 10 }]
                            }
                            Rule for "priceStr":
                            1. If single price, e.g., 50.
                            2. If multiple sizes, use format "Size:Price", comma separated. e.g., "M:50, L:60" or "ä¸­:50, å¤§:60".
                            Rule for "toppings":
                            Extract items from sections like "Add-ons", "Toppings", "åŠ æ–™å€".
                            Language: Traditional Chinese. Pure JSON, no markdown.
                        `;
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                        const response = await fetch(url, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }] }] })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        // Robust JSON extraction
                        const text = data.candidates[0].content.parts[0].text;
                        const jsonStart = text.indexOf('{');
                        const jsonEnd = text.lastIndexOf('}');
                        if (jsonStart === -1 || jsonEnd === -1) throw new Error("ç„¡æ³•è§£æ AI å›å‚³çš„è³‡æ–™æ ¼å¼");
                        const jsonStr = text.substring(jsonStart, jsonEnd + 1);
                        
                        const result = JSON.parse(jsonStr);

                        // Populate Fields
                        if(result.storeName) document.querySelector('[name="storeName"]').value = result.storeName;
                        if(result.category) document.querySelector('[name="category"]').value = result.category;
                        if(result.phone) document.querySelector('[name="phone"]').value = result.phone;
                        if(result.orderLink) document.querySelector('[name="orderLink"]').value = result.orderLink;
                        if(result.isDrinkStore !== undefined) document.getElementById('is-drink-store').checked = result.isDrinkStore;

                        const container = document.getElementById('menu-editor-container');
                        container.innerHTML = '';
                        const items = result.menu || result; 
                        if (Array.isArray(items)) {
                            items.forEach(cat => {
                                const catId = Date.now() + Math.random().toString(16).slice(2);
                                window.app.store.addCategory(cat.category);
                                const lastCat = container.lastElementChild;
                                const lastId = lastCat.dataset.id;
                                lastCat.querySelector('.category-name').value = cat.category;
                                cat.items.forEach(i => window.app.store.addItemToCategory(lastId, i.name, i.priceStr));
                            });
                        }
                        
                        // Populate Toppings
                        if(result.toppings && Array.isArray(result.toppings)) {
                            result.toppings.forEach(t => window.app.store.addTopping(t.name, t.price));
                        }

                        if(statusEl) statusEl.innerText = "âœ… è¾¨è­˜æˆåŠŸï¼";
                        window.app.store.skipToForm();
                        document.getElementById('ai-success-msg').classList.remove('hidden');
                        
                        const previewUrl = URL.createObjectURL(fileInput.files[0]);
                        document.getElementById('img-preview').src = previewUrl;
                        document.getElementById('image-preview-area').classList.remove('hidden');

                    } catch (err) {
                        console.error(err);
                        if(statusEl) statusEl.innerText = "âŒ è¾¨è­˜å¤±æ•—: " + err.message;
                    }
                }
            },

            utils: {
                fileToBase64: (f) => new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f); }),
                resizeImage: (file) => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 800;
                            let w = img.width, h = img.height;
                            if (w > MAX) { h *= MAX / w; w = MAX; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }),
                copyLink: () => {
                    const copyText = document.getElementById("share-link-input");
                    copyText.select();
                    copyText.setSelectionRange(0, 99999);
                    try { document.execCommand("copy"); alert("é€£çµå·²è¤‡è£½ï¼ğŸ“‹"); } catch (err) { alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
                },
                renderPriceTags: (str) => {
                    const variants = window.app.utils.parsePriceVariants(str);
                    
                    // 1. å–®ä¸€è¦æ ¼ï¼šä½¿ç”¨æœ€é†’ç›®çš„ç´…è‰²æ¨™ç±¤ï¼ŒåŠ å¤§å­—é«”
                    if (variants.length === 1 && variants[0].label === 'å–®ä¸€è¦æ ¼') {
                        return `
                        <span class="inline-block text-base font-extrabold text-red-500 bg-red-50 border border-red-100 px-3 py-1 rounded-xl shadow-sm tracking-wide">
                            $${variants[0].price}
                        </span>`;
                    }
                    
                    // 2. å¤šè¦æ ¼ï¼šæ¨™ç±¤åŒ–ï¼Œåƒ¹æ ¼éƒ¨åˆ†åŠ ç²—ä¸¦ä½¿ç”¨ç´…è‰²
                    return `
                    <div class="flex flex-wrap gap-2">
                        ${variants.map(v => `
                            <span class="inline-flex items-center text-xs font-bold text-gray-700 bg-white border-2 border-secondary px-2.5 py-1 rounded-lg shadow-sm whitespace-nowrap">
                                ${v.label} 
                                <span class="text-red-500 ml-1.5 text-sm font-extrabold">$${v.price}</span>
                            </span>
                        `).join('')}
                    </div>`;
                },
                formatPriceRange: (str) => {
                    if(!str) return ''; if(!str.includes(':')) return `$${str}`;
                    const parts = str.split(/[,ï¼Œ]/).map(s => parseInt(s.split(/[:ï¼š]/)[1]));
                    const min = Math.min(...parts); const max = Math.max(...parts);
                    if(min === max) return `$${min}`; return `$${min} ~ $${max}`;
                },
                parsePriceVariants: (str) => {
                    if(!str.includes(':')) return [{label: 'å–®ä¸€è¦æ ¼', price: parseInt(str) || 0}];
                    return str.split(/[,ï¼Œ]/).map(s => { const [label, price] = s.split(/[:ï¼š]/); return { label: label.trim(), price: parseInt(price) || 0 }; });
                },
                getCategoryIcon: (category) => {
                    if (!category) return '<i class="fa-solid fa-shop text-gray-400"></i>';
                    if (category.includes('é£²') || category.includes('èŒ¶') || category.includes('å’–') || category.includes('drink')) return '<i class="fa-solid fa-mug-hot text-orange-400 animate-float"></i>';
                    if (category.includes('é¤') || category.includes('é£¯') || category.includes('éºµ') || category.includes('food')) return '<i class="fa-solid fa-utensils text-red-400 animate-wiggle"></i>';
                    if (category.includes('é»') || category.includes('ç”œ') || category.includes('cake')) return '<i class="fa-solid fa-cookie-bite text-pink-400 animate-float"></i>';
                    if (category.includes('æœ') || category.includes('å†°')) return '<i class="fa-solid fa-ice-cream text-cyan-400 animate-bounce-slow"></i>';
                    return '<i class="fa-solid fa-shop text-primary animate-pulse"></i>';
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('paste', async (e) => {
                if(document.getElementById('modal-add-store').classList.contains('hidden')) return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        const fileInput = document.getElementById('menu-image-upload');
                        const file = new File([blob], "pasted_image.png", { type: blob.type });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        window.app.ai.scanMenu();
                        break;
                    }
                }
            });

            document.getElementById('menu-image-upload').addEventListener('change', async (e) => {
                if(e.target.files[0]) {
                   window.app.ai.scanMenu();
                }
            });
            window.app.init();
        });
    </script>
</body>
</html>