<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜è³¼é»é¤å°å¹«æ‰‹ - å•†å®¶å‡ç´šç‰ˆ</title>
    
    <!-- å¼•å…¥å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF9AA2',   // ç”œå¿ƒç²‰
                        primaryDark: '#FF8090', 
                        secondary: '#FFDAC1', // èœœæ¡ƒè†š
                        accent: '#B5EAD7',    // è–„è·ç¶ 
                        softYellow: '#FFF5BA',
                        textMain: '#6D6875',  
                        bgBase: '#FFFAF4',    
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #FFFAF4; color: #6D6875; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 2px solid #fff;
            box-shadow: 0 8px 32px rgba(255, 154, 162, 0.15);
        }
        .loading-spinner {
            border: 4px solid #fff;
            border-top: 4px solid #FF9AA2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-bounce:active { transform: scale(0.95); }
    </style>
</head>
<body class="selection:bg-secondary selection:text-primaryDark">

    <!-- å…¨åŸŸè¼‰å…¥é®ç½© -->
    <div id="globalLoader" class="fixed inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center transition-opacity duration-500 backdrop-blur-sm">
        <div class="loading-spinner mb-4 shadow-lg bg-white p-1"></div>
        <p class="text-primary font-bold animate-pulse text-lg tracking-widest">LOADING...</p>
    </div>

    <!-- å°èˆªåˆ— -->
    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-secondary/30">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="app.router.go('home')">
                <div class="bg-primary text-white w-9 h-9 rounded-2xl flex items-center justify-center font-bold shadow-md group-hover:rotate-12 transition-transform">
                    <i class="fa-solid fa-utensils"></i>
                </div>
                <h1 class="text-lg font-bold text-textMain group-hover:text-primary transition-colors">é»é¤å°å¹«æ‰‹</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="app.ui.showConfigModal()" class="text-sm px-4 py-1.5 rounded-full bg-secondary/30 hover:bg-secondary text-textMain transition font-bold">
                    <i class="fa-solid fa-gear text-primary"></i> è¨­å®š
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-2xl mx-auto p-4 pb-28 min-h-screen">
        
        <!-- 1. é¦–é  -->
        <div id="view-home" class="view-section hidden space-y-6 animate-fade-in">
            <div class="glass-panel rounded-[2rem] p-8 text-center relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-softYellow rounded-full opacity-50 blur-2xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-accent rounded-full opacity-50 blur-2xl"></div>
                <h2 class="text-3xl font-bold mb-2 text-textMain relative z-10">ä»Šå¤©æƒ³å–é»ä»€éº¼ï¼ŸğŸ¹</h2>
                <p class="text-gray-400 mb-8 text-sm relative z-10">è¼•é¬†é–‹åœ˜ â€§ è‡ªå‹•çµ±è¨ˆ â€§ å¿«æ¨‚åˆ†äº«</p>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <button onclick="app.router.go('create-order')" class="btn-bounce group relative overflow-hidden bg-primary text-white p-6 rounded-3xl shadow-lg shadow-primary/30 transition-all">
                        <div class="absolute -right-4 -top-4 w-16 h-16 bg-white opacity-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                        <i class="fa-solid fa-plus text-3xl mb-3 block"></i>
                        <span class="font-bold text-lg">æˆ‘è¦é–‹åœ˜</span>
                    </button>
                    <button onclick="app.router.go('store-manage')" class="btn-bounce bg-white text-primary border-2 border-primary/20 p-6 rounded-3xl shadow-sm hover:bg-white hover:border-primary transition-all">
                        <i class="fa-solid fa-store text-3xl mb-3 block text-secondary"></i>
                        <span class="font-bold text-lg text-textMain">ç®¡ç†åº—å®¶</span>
                    </button>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-textMain ml-2 mb-3 flex items-center gap-2 text-lg">
                    <span class="w-2 h-6 bg-accent rounded-full"></span> æœ€è¿‘é–‹çš„åœ˜
                </h3>
                <div id="home-order-list" class="space-y-3">
                    <div class="text-center py-12 text-gray-300 bg-white/60 rounded-3xl border border-dashed border-gray-300">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-30"></i>
                        <p>å°šç„¡è¨‚å–®è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. åº—å®¶åˆ—è¡¨ -->
        <div id="view-store-manage" class="view-section hidden space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-textMain">åº—å®¶åˆ—è¡¨ ğŸª</h2>
                <button onclick="app.store.showAddModal()" class="bg-primary hover:bg-primaryDark text-white px-5 py-2.5 rounded-full text-sm shadow-lg shadow-primary/30 transition-all font-bold">
                    <i class="fa-solid fa-plus"></i> æ–°å¢
                </button>
            </div>
            <!-- åˆ†é¡ç¯©é¸ (å¯é¸) -->
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="store-category-filter">
                <!-- JS Render Filter Pills -->
            </div>
            <div id="store-list" class="grid gap-4"></div>
            <button onclick="app.router.go('home')" class="w-full py-4 text-gray-400 font-bold hover:text-textMain transition">â† å›é¦–é </button>
        </div>

        <!-- 3. é–‹åœ˜è¨­å®š -->
        <div id="view-create-order" class="view-section hidden space-y-6">
            <div class="glass-panel p-6 rounded-[2rem]">
                <h2 class="text-xl font-bold mb-6 border-b border-gray-100 pb-4 text-center">âœ¨ ç™¼èµ·åœ˜è³¼</h2>
                <form onsubmit="app.order.create(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-textMain mb-2 ml-1">é¸æ“‡åº—å®¶</label>
                        <div class="relative">
                            <select id="create-order-store" required class="w-full p-4 bg-secondary/10 rounded-2xl border border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none appearance-none font-bold text-gray-600 transition-all">
                                <option value="">è«‹é¸æ“‡...</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-textMain mb-2 ml-1">è¨‚è³¼æ¨™é¡Œ</label>
                        <input type="text" id="create-order-title" required placeholder="ä¾‹å¦‚ï¼šé€±äº”æ­¡æ¨‚ä¸‹åˆèŒ¶ ğŸ§‹" 
                               class="w-full p-4 bg-secondary/10 rounded-2xl border border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none font-bold text-gray-600 transition-all">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/30 transition-all text-lg btn-bounce mt-4">
                        å»ºç«‹ä¸¦å–å¾—é€£çµ ğŸ”—
                    </button>
                </form>
            </div>
            <button onclick="app.router.go('home')" class="w-full text-center text-gray-400 font-bold">å–æ¶ˆ</button>
        </div>

        <!-- 4. é»é¤é é¢ (Participant) -->
        <div id="view-order-menu" class="view-section hidden">
            <!-- Header -->
            <div class="glass-panel p-5 rounded-b-[2rem] mb-4 sticky top-14 z-30 shadow-sm">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 id="menu-order-title" class="text-lg font-bold text-textMain">è¼‰å…¥ä¸­...</h2>
                        <p id="menu-store-name" class="text-sm text-gray-400 mt-1 flex items-center gap-1"><i class="fa-solid fa-shop"></i> ...</p>
                    </div>
                    <span id="menu-status-badge" class="px-3 py-1 bg-accent/30 text-teal-700 text-xs rounded-full font-bold">é€²è¡Œä¸­</span>
                </div>
                <!-- è¯çµ¡æŒ‰éˆ•å€ -->
                <div id="menu-contact-actions" class="flex gap-2 border-t border-gray-100 pt-3 hidden">
                    <a id="btn-call-store" href="#" class="flex-1 py-2 bg-gray-50 rounded-xl text-xs font-bold text-gray-600 text-center hover:bg-green-50 hover:text-green-600 transition"><i class="fa-solid fa-phone mr-1"></i> æ’¥æ‰“é›»è©±</a>
                    <a id="btn-open-store-link" href="#" target="_blank" class="flex-1 py-2 bg-gray-50 rounded-xl text-xs font-bold text-gray-600 text-center hover:bg-blue-50 hover:text-blue-600 transition"><i class="fa-solid fa-link mr-1"></i> å•†å®¶ç³»çµ±</a>
                </div>
            </div>

            <div id="menu-category-nav" class="flex gap-2 overflow-x-auto px-4 pb-2 mb-2 no-scrollbar sticky top-[11rem] z-20 py-2"></div>
            <div id="menu-items-container" class="space-y-8 px-4 pb-28"></div>

            <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md shadow-[0_-8px_30px_rgba(0,0,0,0.08)] p-4 z-50 rounded-t-[2rem] border-t border-gray-100">
                <div class="max-w-2xl mx-auto flex items-center justify-between">
                    <div onclick="app.order.showCartModal()" class="cursor-pointer group pl-2">
                        <p class="text-[10px] text-gray-400 font-bold mb-0.5 group-hover:text-primary transition">ç›®å‰é¸æ“‡</p>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-2xl text-textMain" id="cart-total-price">$0</span>
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded-full font-bold shadow-sm" id="cart-count">0</span>
                        </div>
                    </div>
                    <button onclick="app.order.showSubmitModal()" class="bg-textMain text-white px-8 py-3.5 rounded-2xl font-bold hover:bg-gray-800 transition shadow-lg shadow-gray-300 btn-bounce flex items-center gap-2">
                        <span>é¸å¥½äº†</span> <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 5. åœ˜ä¸»ç®¡ç† (Admin) -->
        <div id="view-admin-dashboard" class="view-section hidden space-y-6">
            <div class="glass-panel p-5 rounded-[2rem] flex justify-between items-center">
                <div>
                    <h2 id="admin-title" class="font-bold text-lg text-textMain">è¨‚å–®çµ±è¨ˆ</h2>
                    <p class="text-xs text-gray-400 mt-1">ID: <span id="admin-order-id"></span></p>
                    <p id="admin-store-phone" class="text-xs text-primary font-bold mt-1 cursor-pointer hidden"><i class="fa-solid fa-phone"></i> <span></span></p>
                </div>
                <button onclick="app.router.go('home')" class="text-xs text-gray-500 border-2 border-gray-100 px-4 py-2 rounded-full font-bold hover:bg-gray-50">è¿”å›</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-secondary/30 p-5 rounded-[2rem] text-center border border-secondary/20">
                    <p class="text-xs text-gray-500 mb-1 font-bold">ç¸½é‡‘é¡</p>
                    <p id="admin-total-amount" class="text-2xl font-bold text-primary">$0</p>
                </div>
                <div class="bg-accent/30 p-5 rounded-[2rem] text-center border border-accent/20">
                    <p class="text-xs text-gray-500 mb-1 font-bold">ç¸½ä»½æ•¸</p>
                    <p id="admin-total-count" class="text-2xl font-bold text-teal-600">0</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="font-bold text-sm mb-4 text-center">ğŸ‘‡ åˆ†äº«é€£çµ</h3>
                <div id="qrcode-container" class="flex justify-center mb-6 p-4 bg-white rounded-xl border-2 border-dashed border-gray-200 w-fit mx-auto"></div>
                <div class="flex gap-2">
                    <input type="text" id="share-link-input" readonly class="flex-1 bg-gray-50 text-xs px-4 py-3 rounded-xl">
                    <button onclick="app.utils.copyLink()" class="bg-textMain text-white px-5 rounded-xl text-xs font-bold">è¤‡è£½</button>
                </div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm overflow-hidden border border-gray-100">
                <div class="flex p-2 bg-gray-50/80 gap-2">
                    <button onclick="app.admin.switchTab('items')" id="tab-items" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white shadow-sm transition-all">å“é …çµ±è¨ˆ</button>
                    <button onclick="app.admin.switchTab('people')" id="tab-people" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 transition-all">äººååˆ—è¡¨</button>
                </div>
                <div id="admin-list-container" class="p-5 max-h-[400px] overflow-y-auto"></div>
            </div>
            <button onclick="app.admin.exportCSV()" class="w-full bg-accent hover:brightness-95 text-teal-800 py-4 rounded-[2rem] font-bold shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-file-csv"></i> åŒ¯å‡º Excel
            </button>
        </div>

        <!-- 6. åº—å®¶è©³æƒ…èˆ‡ç®¡ç† (Store Detail View) -->
        <div id="view-store-detail" class="view-section hidden">
            <div class="glass-panel p-5 rounded-b-[2rem] mb-4 sticky top-14 z-30 shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h2 id="detail-store-name" class="text-xl font-bold text-textMain">...</h2>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span id="detail-store-category" class="text-[10px] bg-softYellow text-orange-700 px-2 py-1 rounded-full font-bold hidden">åˆ†é¡</span>
                            <a id="detail-store-phone" href="#" class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded-full font-bold hidden border border-green-100"><i class="fa-solid fa-phone mr-1"></i><span></span></a>
                            <a id="detail-store-link" href="#" target="_blank" class="text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded-full font-bold hidden border border-blue-100"><i class="fa-solid fa-link mr-1"></i>ç³»çµ±</a>
                        </div>
                    </div>
                    <button onclick="app.router.go('store-manage')" class="text-xs text-gray-400 border border-gray-200 px-3 py-1.5 rounded-full hover:bg-gray-50">è¿”å›</button>
                </div>
                
                <!-- ç®¡ç†å·¥å…·åˆ— -->
                <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-gray-100">
                    <button onclick="app.store.quickAddMode()" class="py-2 bg-primary/10 text-primary rounded-xl text-xs font-bold hover:bg-primary hover:text-white transition flex flex-col items-center gap-1">
                        <i class="fa-solid fa-plus-circle text-lg"></i> å¢åŠ å“é …
                    </button>
                    <button onclick="app.store.retakePhoto()" class="py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100 transition flex flex-col items-center gap-1">
                        <i class="fa-solid fa-camera text-lg"></i> é‡æ–°æ‹ç…§
                    </button>
                    <button onclick="app.store.deleteStore()" class="py-2 bg-red-50 text-red-500 rounded-xl text-xs font-bold hover:bg-red-100 transition flex flex-col items-center gap-1">
                        <i class="fa-solid fa-trash-can text-lg"></i> åˆªé™¤åº—å®¶
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div id="detail-menu-container" class="space-y-8 px-4 pb-28"></div>
        </div>

    </main>

    <!-- Modal: æ–°å¢/ç·¨è¼¯åº—å®¶ (Add Store) -->
    <div id="modal-add-store" class="fixed inset-0 bg-black/40 hidden z-50 items-center justify-center p-4 backdrop-blur-md flex">
        <div class="bg-white rounded-[2rem] w-full max-w-lg p-6 shadow-2xl overflow-y-auto max-h-[90vh] border-4 border-white">
            <h3 class="text-xl font-bold mb-4 text-center">æ–°å¢/ç·¨è¼¯åº—å®¶ ğŸ“</h3>
            
            <form onsubmit="app.store.save(event)" class="space-y-4">
                <input type="hidden" name="storeId" id="edit-store-id"> 
                
                <!-- åˆå§‹ä¸Šå‚³å€ (Stage 1) -->
                <div id="store-initial-upload" class="space-y-4 text-center py-6">
                    <div class="p-6 border-2 border-dashed border-primary/30 rounded-3xl bg-secondary/5 hover:bg-secondary/10 transition cursor-pointer group" onclick="document.getElementById('menu-image-upload').click()">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-md group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-camera text-2xl text-primary"></i>
                        </div>
                        <p class="font-bold text-textMain text-lg">æ‹ç…§ / ä¸Šå‚³èœå–®</p>
                        <p class="text-xs text-gray-400 mt-1">AI è‡ªå‹•è¾¨è­˜åº—åã€é›»è©±èˆ‡å“é …</p>
                    </div>
                    
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-100"></span></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-300">OR</span></div>
                    </div>

                    <div id="paste-area" tabindex="0" class="p-4 border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50 hover:bg-white hover:border-gray-300 transition cursor-text focus:ring-2 focus:ring-primary/20 outline-none">
                        <p class="text-gray-400 text-sm font-bold"><i class="fa-regular fa-clipboard mr-1"></i> é»æ“Šæ­¤è™•ä¸¦æŒ‰ä¸‹ Ctrl+V è²¼ä¸Šåœ–ç‰‡</p>
                    </div>
                    
                    <button type="button" onclick="app.store.skipToForm()" class="text-xs text-gray-400 underline hover:text-primary">è·³éè¾¨è­˜ï¼Œæ‰‹å‹•è¼¸å…¥</button>
                    <!-- Status Display -->
                    <p id="scan-status" class="text-xs text-center mt-2 text-primary font-bold min-h-[1.5rem]"></p>
                </div>

                <!-- è©³ç´°è¡¨å–®å€ (Stage 2 - Hidden by default) -->
                <div id="store-form-details" class="hidden space-y-4 animate-fade-in">
                    <div class="bg-blue-50 p-3 rounded-xl flex items-center gap-3 mb-2" id="ai-success-msg">
                        <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-check"></i></div>
                        <p class="text-xs text-blue-800 font-bold">è¾¨è­˜å®Œæˆï¼è«‹ç¢ºèªä¸‹æ–¹è³‡æ–™</p>
                        <button type="button" onclick="app.store.resetUpload()" class="ml-auto text-xs text-blue-400 underline">é‡é¸åœ–ç‰‡</button>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1 ml-1 text-gray-500">åº—å®¶åç¨± *</label>
                            <input type="text" name="storeName" required class="w-full p-3 bg-gray-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1 ml-1 text-gray-500">å•†å®¶åˆ†é¡</label>
                            <input type="text" name="category" list="category-list" placeholder="å¦‚: é£²æ–™, é¤é£Ÿ" class="w-full p-3 bg-gray-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-primary/20">
                            <datalist id="category-list">
                                <option value="é¤é£Ÿ"><option value="é£²æ–™"><option value="é»å¿ƒ"><option value="å’–å•¡"><option value="ç´ é£Ÿ">
                            </datalist>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1 ml-1 text-gray-500">é›»è©± (é¸å¡«)</label>
                            <input type="tel" name="phone" placeholder="02-12345678" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1 ml-1 text-gray-500">è¨‚é¤ç¶²å€ (é¸å¡«)</label>
                            <input type="url" name="orderLink" placeholder="https://..." class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                    </div>

                    <label class="flex items-center gap-3 p-3 bg-secondary/10 rounded-xl cursor-pointer hover:bg-secondary/20 transition">
                        <input type="checkbox" id="is-drink-store" class="w-5 h-5 text-primary rounded border-gray-300 focus:ring-primary accent-primary">
                        <span class="text-sm font-bold text-gray-700">é€™æ˜¯é£²æ–™åº— <span class="text-xs font-normal text-gray-500">(å•Ÿç”¨ç³–/å†°é¸é …)</span></span>
                    </label>

                    <!-- Toppings Editor -->
                    <div id="toppings-section">
                        <div class="flex justify-between items-center mb-2 mt-4">
                            <label class="block text-sm font-bold ml-1 text-primary">åŠ æ–™å€ (Toppings)</label>
                            <button type="button" onclick="app.store.addTopping()" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded-full font-bold hover:bg-primary hover:text-white transition">+ æ–°å¢é…æ–™</button>
                        </div>
                        <div id="toppings-editor-container" class="space-y-2 p-2 bg-gray-50 rounded-2xl border border-gray-100">
                            <!-- JS Generated toppings -->
                            <div class="text-center py-2 text-xs text-gray-400" id="no-toppings-msg">å°šç„¡åŠ æ–™é¸é …</div>
                        </div>
                    </div>

                    <!-- Preview & Menu Editor -->
                    <div id="image-preview-area" class="hidden mb-2 relative group mt-4">
                        <img id="img-preview" class="max-h-32 rounded-xl border mx-auto shadow-sm object-cover w-full">
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center rounded-xl transition">
                            <span class="text-white text-xs font-bold bg-black/50 px-2 py-1 rounded">å·²é¸åœ–ç‰‡</span>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2 mt-4">
                            <label class="block text-sm font-bold ml-1">èœå–®å…§å®¹</label>
                            <button type="button" onclick="app.store.addCategory()" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded-full font-bold">+ æ–°å¢åˆ†é¡</button>
                        </div>
                        <div id="menu-editor-container" class="space-y-4 max-h-52 overflow-y-auto p-2 bg-gray-50 rounded-2xl border border-gray-100 min-h-[100px]">
                            <div class="text-center py-8 text-xs text-gray-400">è«‹æ–°å¢åˆ†é¡æˆ–ä½¿ç”¨ä¸Šæ–¹å·¥å…·</div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="app.ui.closeModal('modal-add-store')" class="flex-1 py-3 text-gray-400 font-bold hover:bg-gray-50 rounded-xl">å–æ¶ˆ</button>
                        <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 hover:bg-primaryDark transition">å„²å­˜</button>
                    </div>
                </div>

                <!-- Hidden Input for file logic -->
                <input type="file" id="menu-image-upload" accept="image/*" class="hidden">
            </form>
        </div>
    </div>

    <!-- Modal: å–®é …å¿«é€Ÿæ–°å¢ (Quick Add Item) -->
    <div id="modal-quick-add" class="fixed inset-0 bg-black/40 hidden z-[60] items-center justify-center p-4 backdrop-blur-sm flex">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-scale-up">
            <h3 class="font-bold text-lg mb-4 text-center">å¢åŠ å“é …</h3>
            <form onsubmit="app.store.confirmQuickAdd(event)" class="space-y-3">
                <select id="quick-add-category" class="w-full p-2 bg-gray-50 rounded-lg text-sm font-bold outline-none"></select>
                <input type="text" id="quick-add-name" required placeholder="å“å" class="w-full p-2 bg-gray-50 rounded-lg text-sm outline-none">
                <input type="text" id="quick-add-price" required placeholder="åƒ¹æ ¼ (å¦‚: 50)" class="w-full p-2 bg-gray-50 rounded-lg text-sm outline-none">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="app.ui.closeModal('modal-quick-add')" class="flex-1 py-2 text-gray-400 text-sm font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-bold">åŠ å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: è¨­å®š (Settings) -->
    <div id="modal-config" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md transition-opacity">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-6 shadow-2xl animate-scale-up max-h-[90vh] overflow-y-auto border-4 border-white">
            <h3 class="text-xl font-bold mb-6 text-center text-textMain">âš™ï¸ ç³»çµ±è¨­å®š</h3>
            <p id="config-error-msg" class="text-xs text-red-500 mb-2 hidden"></p> <!-- Error Msg -->
            <div class="mb-5">
                <label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">Base URL</label>
                <input type="text" id="config-base-url" class="w-full p-3 bg-gray-50 rounded-xl text-sm border border-gray-100 focus:ring-2 focus:ring-primary/20 outline-none transition">
            </div>
            <div class="mb-5">
                <label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">Firebase Config</label>
                <textarea id="config-input" class="w-full h-32 p-3 bg-gray-50 rounded-xl text-xs font-mono border border-gray-100 focus:ring-2 focus:ring-primary/20 outline-none transition"></textarea>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold mb-2 text-gray-400 uppercase tracking-wider">AI (Gemini)</label>
                <div class="flex gap-2 mb-3 bg-gray-50 p-1 rounded-xl">
                    <button onclick="app.config.setAiMode('default')" id="btn-ai-default" class="flex-1 py-2 text-xs rounded-lg font-bold">é è¨­</button>
                    <button onclick="app.config.setAiMode('custom')" id="btn-ai-custom" class="flex-1 py-2 text-xs rounded-lg font-bold">è‡ªè¨‚ Key</button>
                </div>
                <input type="password" id="custom-ai-key" class="w-full p-3 bg-white border border-gray-200 rounded-xl text-sm hidden" placeholder="è¼¸å…¥ API Key">
            </div>
            <div class="mb-6 border-t border-gray-100 pt-4">
                <button onclick="app.config.generateShareUrl()" class="w-full bg-textMain text-white py-3 rounded-xl text-sm font-bold">ç”¢ç”Ÿé€£çµ</button>
                <div id="config-share-result" class="hidden mt-4 bg-gray-50 p-4 rounded-xl text-center">
                    <div id="config-qrcode" class="flex justify-center mb-3 bg-white p-2 w-fit mx-auto rounded-lg"></div>
                    <input type="text" id="config-share-url" readonly class="w-full text-xs p-2 bg-white rounded border border-gray-200 text-gray-500 text-center">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="app.ui.closeModal('modal-config')" class="flex-1 py-3 text-gray-400 font-bold hover:bg-gray-50 rounded-xl">é—œé–‰</button>
                <button onclick="app.config.save()" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, orderBy, onSnapshot, serverTimestamp, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config (Embedded) ---
        const HARDCODED_CONFIG = {
            apiKey: "AIzaSyCfP75XPViRbVsTRlsQDY2Caty-iuIGDsQ",
            authDomain: "grouporderapp-c7036.firebaseapp.com",
            projectId: "grouporderapp-c7036",
            storageBucket: "grouporderapp-c7036.firebasestorage.app",
            messagingSenderId: "1087210025698",
            appId: "1:1087210025698:web:f0507fc2ad84721504e4bb"
        };

        window.db = null; window.auth = null; window.currentUser = null;
        const appId = 'food-ordering-app';

        window.app = {
            state: {
                currentView: 'home',
                stores: [],
                currentOrder: null,
                cart: [], 
                aiMode: localStorage.getItem(`${appId}_ai_mode`) || 'default',
                baseUrl: localStorage.getItem(`${appId}_base_url`) || (window.location.origin + window.location.pathname),
                tempItem: null,
                viewingStoreId: null, 
            },

            init: async () => { await app.config.load(); },

            config: {
                load: async () => {
                    let finalConfig = null;
                    const urlParams = new URLSearchParams(window.location.search);
                    const encodedConfig = urlParams.get('config');
                    if (encodedConfig) {
                        try {
                            finalConfig = JSON.parse(atob(encodedConfig));
                            localStorage.setItem(`${appId}_firebase_config`, JSON.stringify(finalConfig));
                            const newUrl = window.location.pathname + (urlParams.get('orderId') ? `?orderId=${urlParams.get('orderId')}` : '');
                            window.history.replaceState({}, document.title, newUrl);
                        } catch (e) {}
                    }
                    if (!finalConfig) finalConfig = JSON.parse(localStorage.getItem(`${appId}_firebase_config`));
                    if (!finalConfig && HARDCODED_CONFIG.apiKey !== 'demo') finalConfig = HARDCODED_CONFIG;

                    if (finalConfig && finalConfig.apiKey !== 'demo') {
                        try {
                            const firebaseApp = getApps().length === 0 ? initializeApp(finalConfig) : getApp();
                            window.auth = getAuth(firebaseApp);
                            window.db = getFirestore(firebaseApp);
                            
                            await signInAnonymously(window.auth);
                            window.currentUser = window.auth.currentUser;
                            document.getElementById('globalLoader').classList.add('opacity-0', 'pointer-events-none');
                            
                            const orderId = new URLSearchParams(window.location.search).get('orderId');
                            if (orderId) app.router.go('order-menu', { orderId });
                            else app.router.go('home');
                            app.store.loadAll();
                        } catch (err) {
                            console.error("Firebase Init Failed:", err);
                            document.getElementById('config-error-msg').innerText = "é€£ç·šå¤±æ•—: " + err.message;
                            document.getElementById('config-error-msg').classList.remove('hidden');
                            app.ui.showConfigModal(); 
                            document.getElementById('globalLoader').classList.add('hidden');
                        }
                    } else {
                        document.getElementById('globalLoader').classList.add('hidden');
                        app.ui.showConfigModal();
                    }
                },
                save: () => {
                    const text = document.getElementById('config-input').value;
                    const regex = /(apiKey|authDomain|projectId|storageBucket|messagingSenderId|appId)\s*[:=]\s*['"]?([^'"\s,]+)['"]?/g;
                    let match; const config = {}; let count = 0;
                    while ((match = regex.exec(text)) !== null) { config[match[1]] = match[2]; count++; }
                    const newBaseUrl = document.getElementById('config-base-url').value.trim();
                    if(newBaseUrl) { localStorage.setItem(`${appId}_base_url`, newBaseUrl); app.state.baseUrl = newBaseUrl; }
                    else { const current = window.location.origin + window.location.pathname; localStorage.setItem(`${appId}_base_url`, current); app.state.baseUrl = current; }
                    if (count >= 6) {
                        localStorage.setItem(`${appId}_firebase_config`, JSON.stringify(config));
                        const aiMode = document.getElementById('btn-ai-custom').classList.contains('bg-primary') ? 'custom' : 'default';
                        localStorage.setItem(`${appId}_ai_mode`, aiMode);
                        if (aiMode === 'custom') localStorage.setItem(`${appId}_ai_key`, document.getElementById('custom-ai-key').value);
                        window.location.reload();
                    } else {
                        if(HARDCODED_CONFIG.apiKey !== 'demo') { localStorage.removeItem(`${appId}_firebase_config`); window.location.reload(); } else { alert("è¨­å®šæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰ 6 å€‹æ¬„ä½"); }
                    }
                },
                setAiMode: (mode) => {
                    if (mode === 'default') {
                        document.getElementById('btn-ai-default').className = 'flex-1 py-2 text-xs rounded-lg border border-primary bg-primary text-white font-bold';
                        document.getElementById('btn-ai-custom').className = 'flex-1 py-2 text-xs rounded-lg border border-gray-200 text-gray-400 font-bold';
                        document.getElementById('custom-ai-key').classList.add('hidden');
                    } else {
                        document.getElementById('btn-ai-default').className = 'flex-1 py-2 text-xs rounded-lg border border-gray-200 text-gray-400 font-bold';
                        document.getElementById('btn-ai-custom').className = 'flex-1 py-2 text-xs rounded-lg border border-primary bg-primary text-white font-bold';
                        document.getElementById('custom-ai-key').classList.remove('hidden');
                    }
                },
                generateShareUrl: () => {
                    const stored = localStorage.getItem(`${appId}_firebase_config`) || JSON.stringify(HARDCODED_CONFIG);
                    const url = `${app.state.baseUrl}?config=${btoa(stored)}`;
                    document.getElementById('config-share-result').classList.remove('hidden');
                    document.getElementById('config-share-url').value = url;
                    document.getElementById('config-qrcode').innerHTML = "";
                    new QRCode(document.getElementById('config-qrcode'), { text: url, width: 128, height: 128 });
                }
            },

            router: {
                go: (viewName, params = {}) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${viewName}`).classList.remove('hidden');
                    window.scrollTo(0,0);
                    if (viewName === 'home') app.order.loadHistory();
                    if (viewName === 'store-manage') app.store.renderList();
                    if (viewName === 'create-order') app.store.renderSelectOptions();
                    if (viewName === 'order-menu' && params.orderId) app.order.initMenu(params.orderId);
                    if (viewName === 'admin-dashboard' && params.orderId) app.admin.init(params.orderId);
                }
            },

            ui: {
                showConfigModal: () => {
                    document.getElementById('modal-config').classList.remove('hidden');
                    document.getElementById('modal-config').classList.add('flex');
                    let stored = localStorage.getItem(`${appId}_firebase_config`);
                    if(!stored && HARDCODED_CONFIG.apiKey !== 'demo') stored = JSON.stringify(HARDCODED_CONFIG);
                    if (stored) {
                        const c = JSON.parse(stored);
                        let str = ""; for (let k in c) str += `${k}: "${c[k]}",\n`;
                        document.getElementById('config-input').value = str;
                    }
                    document.getElementById('config-base-url').value = app.state.baseUrl;
                    app.config.setAiMode(app.state.aiMode);
                },
                closeModal: (id) => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                },
                showHelpModal: () => alert("è«‹å‰å¾€ Firebase Console -> Project Settings -> General -> è¤‡è£½è¨­å®šã€‚")
            },

            store: {
                loadAll: async () => {
                    if (!window.db) return;
                    const q = query(collection(window.db, "stores"), orderBy("createdAt", "desc"));
                    const snapshot = await getDocs(q);
                    app.state.stores = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                },
                showAddModal: (isRetake = false) => {
                    document.querySelector('#modal-add-store form').reset();
                    document.getElementById('menu-editor-container').innerHTML = '';
                    document.getElementById('toppings-editor-container').innerHTML = '<div class="text-center py-2 text-xs text-gray-400" id="no-toppings-msg">å°šç„¡åŠ æ–™é¸é …</div>';
                    document.getElementById('edit-store-id').value = '';
                    document.getElementById('img-preview').src = '';
                    document.getElementById('image-preview-area').classList.add('hidden');
                    document.getElementById('ai-success-msg').classList.add('hidden');
                    document.getElementById('store-initial-upload').classList.remove('hidden');
                    document.getElementById('store-form-details').classList.add('hidden');
                    if (isRetake && app.state.viewingStoreId) {
                        const store = app.state.stores.find(s => s.id === app.state.viewingStoreId);
                        if(store) {
                            document.querySelector('[name="storeName"]').value = store.name;
                            document.querySelector('[name="category"]').value = store.category || '';
                            document.querySelector('[name="phone"]').value = store.phone || '';
                            document.querySelector('[name="orderLink"]').value = store.orderLink || '';
                            document.getElementById('is-drink-store').checked = store.isDrinkStore || false;
                            document.getElementById('edit-store-id').value = store.id;
                            if(store.menu) {
                                store.menu.forEach(cat => {
                                    app.store.addCategory(cat.category);
                                    const lastCat = document.getElementById('menu-editor-container').lastElementChild;
                                    cat.items.forEach(i => app.store.addItemToCategory(lastCat.dataset.id, i.name, i.priceStr));
                                });
                            }
                            if(store.toppings && store.toppings.length > 0) {
                                const msg = document.getElementById('no-toppings-msg'); if(msg) msg.remove();
                                store.toppings.forEach(t => app.store.addTopping(t.name, t.price));
                            }
                        }
                    }
                    document.getElementById('modal-add-store').classList.remove('hidden');
                    document.getElementById('modal-add-store').classList.add('flex');
                },
                resetUpload: () => { document.getElementById('store-initial-upload').classList.remove('hidden'); document.getElementById('store-form-details').classList.add('hidden'); },
                skipToForm: () => { document.getElementById('store-initial-upload').classList.add('hidden'); document.getElementById('store-form-details').classList.remove('hidden'); if(document.getElementById('menu-editor-container').children.length === 0) app.store.addCategory('ç†±é–€å•†å“'); },
                addCategory: (name = '') => {
                    const id = Date.now() + Math.random().toString(16).slice(2);
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-xl border border-gray-100 category-block relative group mb-3 shadow-sm";
                    div.dataset.id = id;
                    div.innerHTML = `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-50"><i class="fa-solid fa-layer-group text-primary"></i><input type="text" placeholder="åˆ†é¡åç¨±" value="${name}" class="category-name flex-1 font-bold bg-transparent border-none focus:ring-0 outline-none py-1 text-sm text-textMain"><button type="button" onclick="this.closest('.category-block').remove()" class="text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button></div><div class="space-y-2 item-list pl-2"></div><button type="button" onclick="app.store.addItemToCategory('${id}')" class="mt-2 text-xs text-primary font-bold hover:bg-secondary/20 px-3 py-1.5 rounded-full transition">+ æ–°å¢å“é …</button>`;
                    document.getElementById('menu-editor-container').appendChild(div);
                    if(!name) app.store.addItemToCategory(id);
                },
                addItemToCategory: (catId, name='', priceStr='') => {
                    const catBlock = document.querySelector(`.category-block[data-id="${catId}"] .item-list`);
                    if(!catBlock) return;
                    const div = document.createElement('div');
                    div.className = "flex gap-2 items-center menu-item-row";
                    div.innerHTML = `<input type="text" placeholder="å“å" value="${name}" class="item-name w-3/5 p-2 bg-gray-50 rounded-lg text-sm focus:bg-white focus:ring-1 focus:ring-primary outline-none font-medium"><input type="text" placeholder="$" value="${priceStr}" class="item-price w-2/5 p-2 bg-gray-50 rounded-lg text-sm focus:bg-white focus:ring-1 focus:ring-primary outline-none font-medium"><button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-400 w-6"><i class="fa-solid fa-xmark"></i></button>`;
                    catBlock.appendChild(div);
                },
                addTopping: (name='', price='') => {
                    const container = document.getElementById('toppings-editor-container');
                    const msg = document.getElementById('no-toppings-msg'); if(msg) msg.remove();
                    const div = document.createElement('div');
                    div.className = "flex gap-2 items-center topping-item-row";
                    div.innerHTML = `<input type="text" placeholder="åŠ æ–™åç¨±" value="${name}" class="topping-name w-3/5 p-2 bg-white rounded-lg text-sm border border-gray-100 focus:border-primary outline-none"><input type="number" placeholder="$" value="${price}" class="topping-price w-2/5 p-2 bg-white rounded-lg text-sm border border-gray-100 focus:border-primary outline-none"><button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-400 w-6"><i class="fa-solid fa-xmark"></i></button>`;
                    container.appendChild(div);
                },
                save: async (e) => {
                    e.preventDefault();
                    if (!window.db) return app.ui.showConfigModal();
                    const form = e.target;
                    const storeId = document.getElementById('edit-store-id').value;
                    const name = form.storeName.value;
                    const category = form.category.value;
                    const phone = form.phone.value;
                    const orderLink = form.orderLink.value;
                    const isDrinkStore = document.getElementById('is-drink-store').checked;
                    const menu = []; const toppings = [];
                    document.querySelectorAll('.category-block').forEach(catEl => {
                        const catName = catEl.querySelector('.category-name').value.trim();
                        if(!catName) return;
                        const items = [];
                        catEl.querySelectorAll('.menu-item-row').forEach(row => { const n = row.querySelector('.item-name').value.trim(); const pStr = row.querySelector('.item-price').value.trim(); if(n && pStr) items.push({ name: n, priceStr: pStr }); });
                        if(items.length > 0) menu.push({ category: catName, items });
                    });
                    document.querySelectorAll('.topping-item-row').forEach(row => { const n = row.querySelector('.topping-name').value.trim(); const p = row.querySelector('.topping-price').value.trim(); if(n && p) toppings.push({ name: n, price: parseInt(p) }); });
                    let imageBase64 = null;
                    const fileInput = document.getElementById('menu-image-upload');
                    if (fileInput.files[0]) imageBase64 = await app.utils.resizeImage(fileInput.files[0]);
                    const data = { name, category, phone, orderLink, isDrinkStore, menu, toppings, updatedAt: serverTimestamp() };
                    if(imageBase64) data.image = imageBase64;
                    try {
                        if(storeId) { await updateDoc(doc(window.db, "stores", storeId), data); alert("åº—å®¶è³‡æ–™å·²æ›´æ–°ï¼"); }
                        else { data.createdAt = serverTimestamp(); await addDoc(collection(window.db, "stores"), data); alert("åº—å®¶æ–°å¢æˆåŠŸï¼ğŸ‰"); }
                        app.ui.closeModal('modal-add-store'); await app.store.loadAll();
                        if(storeId) app.store.viewDetail(storeId); else app.router.go('store-manage');
                    } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
                },
                viewDetail: (storeId) => {
                    const store = app.state.stores.find(s => s.id === storeId);
                    if (!store) return;
                    app.state.viewingStoreId = storeId;
                    document.getElementById('detail-store-name').innerText = store.name;
                    const catEl = document.getElementById('detail-store-category'); if(store.category) { catEl.innerText = store.category; catEl.classList.remove('hidden'); } else { catEl.classList.add('hidden'); }
                    const phoneEl = document.getElementById('detail-store-phone'); if(store.phone) { phoneEl.href = `tel:${store.phone}`; phoneEl.querySelector('span').innerText = store.phone; phoneEl.classList.remove('hidden'); } else { phoneEl.classList.add('hidden'); }
                    const linkEl = document.getElementById('detail-store-link'); if(store.orderLink) { linkEl.href = store.orderLink; linkEl.classList.remove('hidden'); } else { linkEl.classList.add('hidden'); }
                    const container = document.getElementById('detail-menu-container');
                    let menuToRender = store.menu || (store.items ? [{ category: 'ç²¾é¸å•†å“', items: store.items.map(i => ({name: i.name, priceStr: i.price.toString()})) }] : []);
                    if (!menuToRender || menuToRender.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡èœå–®è³‡æ–™</div>'; }
                    else {
                        container.innerHTML = menuToRender.map((cat, idx) => `<div><h3 class="font-bold text-textMain mb-4 ml-2 text-lg flex items-center gap-2"><span class="w-1.5 h-6 bg-secondary rounded-full"></span>${cat.category}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${cat.items.map(item => `<div class="bg-white p-4 rounded-[1.5rem] shadow-sm border border-gray-50 flex flex-col justify-between h-full hover:shadow-md transition"><div><h4 class="font-bold text-textMain text-base line-clamp-2 leading-tight">${item.name}</h4><div class="mt-3">${app.utils.renderPriceTags(item.priceStr)}</div></div></div>`).join('')}</div></div>`).join('');
                    }
                    app.router.go('store-detail');
                },
                quickAddMode: () => {
                    const store = app.state.stores.find(s => s.id === app.state.viewingStoreId);
                    const sel = document.getElementById('quick-add-category');
                    sel.innerHTML = store.menu.map(c => `<option value="${c.category}">${c.category}</option>`).join('');
                    document.getElementById('modal-quick-add').classList.remove('hidden'); document.getElementById('modal-quick-add').classList.add('flex');
                },
                confirmQuickAdd: async (e) => {
                    e.preventDefault();
                    const catName = document.getElementById('quick-add-category').value;
                    const name = document.getElementById('quick-add-name').value;
                    const price = document.getElementById('quick-add-price').value;
                    const store = app.state.stores.find(s => s.id === app.state.viewingStoreId);
                    const newMenu = [...store.menu];
                    const catIndex = newMenu.findIndex(c => c.category === catName);
                    if(catIndex > -1) { newMenu[catIndex].items.push({name, priceStr: price}); await updateDoc(doc(window.db, "stores", store.id), { menu: newMenu }); alert("å·²åŠ å…¥ï¼"); app.ui.closeModal('modal-quick-add'); document.getElementById('quick-add-name').value = ''; document.getElementById('quick-add-price').value = ''; await app.store.loadAll(); app.store.viewDetail(store.id); }
                },
                retakePhoto: () => { app.store.showAddModal(true); },
                deleteStore: async () => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹åº—å®¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) { await deleteDoc(doc(window.db, "stores", app.state.viewingStoreId)); alert("åº—å®¶å·²åˆªé™¤"); app.store.loadAll(); app.router.go('store-manage'); } },
                renderList: () => {
                    const container = document.getElementById('store-list');
                    container.innerHTML = app.state.stores.map(s => {
                        const itemCount = s.menu ? s.menu.reduce((acc, c) => acc + c.items.length, 0) : (s.items ? s.items.length : 0);
                        return `<div onclick="app.store.viewDetail('${s.id}')" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-gray-100 flex justify-between items-center group hover:shadow-md transition cursor-pointer"><div><h3 class="font-bold text-lg flex items-center gap-2 text-textMain"><i class="fa-solid fa-shop text-primary/50"></i> ${s.name} ${s.category ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">${s.category}</span>` : ''}</h3><p class="text-xs text-gray-400 mt-1 pl-6">${itemCount} å€‹å“é … ${s.phone ? `â€¢ ğŸ“ ${s.phone}` : ''}</p></div><div class="text-right"><span class="text-gray-300 text-sm group-hover:text-primary transition"><i class="fa-solid fa-chevron-right"></i></span></div></div>`;
                    }).join('');
                },
                renderSelectOptions: () => {
                    const sel = document.getElementById('create-order-store');
                    sel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>' + app.state.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                }
            },

            order: {
                create: async (e) => {
                    e.preventDefault();
                    if (!window.db) return app.ui.showConfigModal();
                    const storeId = document.getElementById('create-order-store').value;
                    const title = document.getElementById('create-order-title').value;
                    const storeData = app.state.stores.find(s => s.id === storeId);
                    if (!storeId) return alert("è«‹é¸æ“‡åº—å®¶");
                    let finalMenu = storeData.menu || [{ category: 'ç²¾é¸å•†å“', items: storeData.items.map(i => ({name: i.name, priceStr: i.price.toString()})) }];
                    // Store Toppings
                    let toppings = storeData.toppings || [];
                    try {
                        const docRef = await addDoc(collection(window.db, "orders"), {
                            storeId, storeName: storeData.name, storePhone: storeData.phone || "", storeLink: storeData.orderLink || "", isDrinkStore: storeData.isDrinkStore || false, menu: finalMenu, toppings, title, hostId: window.currentUser.uid, createdAt: serverTimestamp(), status: 'active'
                        });
                        const history = JSON.parse(localStorage.getItem(`${appId}_my_orders`) || "[]");
                        history.push({ id: docRef.id, title, date: new Date().toISOString() });
                        localStorage.setItem(`${appId}_my_orders`, JSON.stringify(history));
                        app.router.go('admin-dashboard', { orderId: docRef.id });
                    } catch (err) { alert("é–‹åœ˜å¤±æ•—: " + err.message); }
                },
                loadHistory: () => {
                    const history = JSON.parse(localStorage.getItem(`${appId}_my_orders`) || "[]");
                    const container = document.getElementById('home-order-list');
                    if (history.length === 0) return;
                    container.innerHTML = history.reverse().map(o => `<div onclick="app.router.go('admin-dashboard', {orderId: '${o.id}'})" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-gray-100 cursor-pointer hover:bg-white hover:shadow-md transition group relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-2 bg-secondary"></div><h4 class="font-bold text-textMain text-lg">${o.title}</h4><p class="text-xs text-gray-400 mt-1 flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${new Date(o.date).toLocaleDateString()}</p><i class="fa-solid fa-chevron-right absolute right-5 top-1/2 -translate-y-1/2 text-gray-200 group-hover:text-primary transition"></i></div>`).join('');
                },
                initMenu: async (orderId) => {
                    if (!window.db) return app.ui.showConfigModal();
                    const docSnap = await getDoc(doc(window.db, "orders", orderId));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        app.state.currentOrder = { id: orderId, ...data };
                        document.getElementById('menu-order-title').innerText = data.title;
                        document.getElementById('menu-store-name').innerHTML = `<i class="fa-solid fa-shop mr-1"></i> ${data.storeName}`;
                        const contactContainer = document.getElementById('menu-contact-actions');
                        if (data.storePhone || data.storeLink) {
                            contactContainer.classList.remove('hidden');
                            if(data.storePhone) document.getElementById('btn-call-store').href = `tel:${data.storePhone}`; else document.getElementById('btn-call-store').classList.add('hidden');
                            if(data.storeLink) document.getElementById('btn-open-store-link').href = data.storeLink; else document.getElementById('btn-open-store-link').classList.add('hidden');
                        } else { contactContainer.classList.add('hidden'); }
                        const nav = document.getElementById('menu-category-nav');
                        nav.innerHTML = data.menu.map((cat, idx) => `<a href="#cat-${idx}" class="whitespace-nowrap px-4 py-2 rounded-full bg-white border border-gray-100 text-sm font-bold text-gray-500 shadow-sm hover:text-primary hover:border-primary/30 active:scale-95 transition snap-center">${cat.category}</a>`).join('');
                        const container = document.getElementById('menu-items-container');
                        container.innerHTML = data.menu.map((cat, idx) => `<div id="cat-${idx}" class="scroll-mt-32"><h3 class="font-bold text-textMain mb-4 ml-2 text-lg flex items-center gap-2"><span class="w-1.5 h-6 bg-primary rounded-full"></span>${cat.category}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${cat.items.map((item, iIdx) => `<div onclick="app.order.openItemModal(${idx}, ${iIdx})" class="group bg-white p-4 rounded-[1.5rem] shadow-sm border-2 border-secondary/30 flex flex-col justify-between h-full transition-all duration-300 hover:-translate-y-1 hover:shadow-[0_8px_20px_-5px_rgba(255,154,162,0.3)] hover:border-primary/50 active:scale-95 cursor-pointer relative overflow-hidden"><div class="absolute -right-4 -top-4 w-16 h-16 bg-gradient-to-br from-secondary/40 to-primary/10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div><div class="relative z-10"><h4 class="font-bold text-textMain text-base line-clamp-2 leading-tight">${item.name}</h4><div class="mt-3 flex items-end justify-between gap-2"><div class="flex-1">${app.utils.renderPriceTags(item.priceStr)}</div><div class="w-8 h-8 bg-secondary/20 rounded-full flex-shrink-0 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors shadow-sm"><i class="fa-solid fa-plus text-xs"></i></div></div></div></div>`).join('')}</div></div>`).join('');
                        app.state.cart = []; app.order.renderCartTotal();
                    } else { alert("è¨‚å–®ä¸å­˜åœ¨"); app.router.go('home'); }
                },
                openItemModal: (catIdx, itemIdx) => {
                    const order = app.state.currentOrder;
                    const item = order.menu[catIdx].items[itemIdx];
                    const variants = app.utils.parsePriceVariants(item.priceStr);
                    app.state.tempItem = { name: item.name, baseVariants: variants, selectedVariant: variants[0], sugar: 'ç„¡ç³–', ice: 'å»å†°', qty: 1, selectedToppings: [] };
                    document.getElementById('detail-item-name').innerText = item.name;
                    document.getElementById('detail-qty').innerText = 1;
                    const container = document.getElementById('detail-options-container');
                    let html = '';
                    if (variants.length > 1 || (variants.length === 1 && variants[0].label !== 'å–®ä¸€è¦æ ¼')) {
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">å®¹é‡è¦æ ¼</p><div class="flex flex-wrap gap-2">${variants.map((v, idx) => `<button onclick="app.order.selectVariant(${idx})" class="variant-btn px-5 py-3 rounded-2xl border transition-all text-sm font-bold ${idx===0?'border-primary bg-primary text-white shadow-md shadow-primary/30':'border-gray-100 bg-gray-50 text-gray-500 hover:bg-gray-100'}" data-idx="${idx}">${v.label} <span class="ml-1 text-xs opacity-80">$${v.price}</span></button>`).join('')}</div></div>`;
                    }
                    if (order.isDrinkStore) {
                        const sugars = ['æ­£å¸¸ç³–','å°‘ç³–','åŠç³–','å¾®ç³–','ç„¡ç³–'];
                        const ices = ['æ­£å¸¸å†°','å°‘å†°','åŠå†°','å¾®å†°','å»å†°','æº«','ç†±'];
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">ç³–åº¦é¸æ“‡</p><div class="flex flex-wrap gap-2">${sugars.map(s => `<button onclick="app.order.selectOption('sugar', '${s}', this)" class="sugar-btn px-4 py-2 rounded-xl border transition-all text-xs font-bold ${s==='ç„¡ç³–'?'border-secondary bg-secondary text-primaryDark':'border-gray-100 bg-white text-gray-500 hover:bg-gray-50'}">${s}</button>`).join('')}</div></div>`;
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">å†°å¡Šé¸æ“‡</p><div class="flex flex-wrap gap-2">${ices.map(i => `<button onclick="app.order.selectOption('ice', '${i}', this)" class="ice-btn px-4 py-2 rounded-xl border transition-all text-xs font-bold ${i==='å»å†°'?'border-accent bg-accent text-teal-800':'border-gray-100 bg-white text-gray-500 hover:bg-gray-50'}">${i}</button>`).join('')}</div></div>`;
                    }
                    if (order.toppings && order.toppings.length > 0) {
                        html += `<div class="mb-5"><p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">åŠ æ–™å€</p><div class="flex flex-wrap gap-2">${order.toppings.map((t, idx) => `<button onclick="app.order.toggleTopping(${idx}, this)" class="topping-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold" data-price="${t.price}">${t.name} +$${t.price}</button>`).join('')}</div></div>`;
                    }
                    container.innerHTML = html;
                    app.order.updateDetailPrice();
                    document.getElementById('modal-item-detail').classList.remove('hidden'); document.getElementById('modal-item-detail').classList.add('flex');
                },
                selectVariant: (idx) => { app.state.tempItem.selectedVariant = app.state.tempItem.baseVariants[idx]; document.querySelectorAll('.variant-btn').forEach(b => b.className = 'variant-btn px-5 py-3 rounded-2xl border border-gray-100 bg-gray-50 text-gray-500 hover:bg-gray-100 transition-all text-sm font-bold'); document.querySelector(`.variant-btn[data-idx="${idx}"]`).className = 'variant-btn px-5 py-3 rounded-2xl border border-primary bg-primary text-white shadow-md shadow-primary/30 transition-all text-sm font-bold'; app.order.updateDetailPrice(); },
                selectOption: (type, val, btn) => { app.state.tempItem[type] = val; const cls = `.${type}-btn`; const activeClass = type === 'sugar' ? 'border-secondary bg-secondary text-primaryDark' : 'border-accent bg-accent text-teal-800'; document.querySelectorAll(cls).forEach(b => b.className = `${type}-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold`); btn.className = `${type}-btn px-4 py-2 rounded-xl border ${activeClass} transition-all text-xs font-bold`; },
                toggleTopping: (idx, btn) => {
                    const topping = app.state.currentOrder.toppings[idx];
                    const existsIdx = app.state.tempItem.selectedToppings.findIndex(t => t.name === topping.name);
                    if(existsIdx > -1) { app.state.tempItem.selectedToppings.splice(existsIdx, 1); btn.className = 'topping-btn px-4 py-2 rounded-xl border border-gray-100 bg-white text-gray-500 hover:bg-gray-50 transition-all text-xs font-bold'; }
                    else { app.state.tempItem.selectedToppings.push(topping); btn.className = 'topping-btn px-4 py-2 rounded-xl border border-primary/50 bg-primary/10 text-primary font-bold transition-all text-xs'; }
                    app.order.updateDetailPrice();
                },
                detailQty: (delta) => { let newQty = app.state.tempItem.qty + delta; if(newQty < 1) newQty = 1; app.state.tempItem.qty = newQty; document.getElementById('detail-qty').innerText = newQty; app.order.updateDetailPrice(); },
                updateDetailPrice: () => {
                    const base = app.state.tempItem.selectedVariant.price;
                    const toppings = app.state.tempItem.selectedToppings.reduce((sum, t) => sum + t.price, 0);
                    const total = (base + toppings) * app.state.tempItem.qty;
                    document.getElementById('detail-base-price').innerText = `$${base}`;
                    if(toppings > 0) document.getElementById('detail-base-price').innerText += ` (+${toppings})`;
                    document.getElementById('detail-add-price').innerText = `$${total}`;
                },
                addToCartFromDetail: () => {
                    const t = app.state.tempItem;
                    let variantsText = "";
                    if (t.baseVariants.length > 1 || t.baseVariants[0].label !== 'å–®ä¸€è¦æ ¼') variantsText += t.selectedVariant.label;
                    if (app.state.currentOrder.isDrinkStore) variantsText += ` (${t.sugar}/${t.ice})`;
                    if (t.selectedToppings.length > 0) variantsText += ` +${t.selectedToppings.map(tp=>tp.name).join(',')}`;
                    const toppingsPrice = t.selectedToppings.reduce((sum, tp) => sum + tp.price, 0);
                    const unitPrice = t.selectedVariant.price + toppingsPrice;
                    app.state.cart.push({ id: Date.now(), name: t.name, price: unitPrice, qty: t.qty, variantsText: variantsText, fullPrice: unitPrice * t.qty });
                    app.ui.closeModal('modal-item-detail'); app.order.renderCartTotal();
                },
                renderCartTotal: () => { const total = app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0); const count = app.state.cart.reduce((sum, i) => sum + i.qty, 0); document.getElementById('cart-total-price').innerText = `$${total}`; document.getElementById('cart-count').innerText = count; },
                showSubmitModal: () => { app.order.showCartModal(); document.getElementById('modal-submit-order').classList.remove('hidden'); document.getElementById('modal-submit-order').classList.add('flex'); document.getElementById('participant-name').focus(); },
                showCartModal: () => { const summary = document.getElementById('cart-summary'); if(app.state.cart.length === 0) { summary.innerHTML = '<p class="text-center text-gray-400 py-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ ğŸ›’</p>'; document.getElementById('final-total').innerText = '$0'; return; } summary.innerHTML = app.state.cart.map((i, idx) => `<div class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0"><div><div class="font-bold text-gray-800">${i.name} <span class="text-primary">x${i.qty}</span></div><div class="text-[10px] text-gray-400 mt-0.5">${i.variantsText}</div></div><div class="flex items-center gap-3"><span class="font-bold text-gray-600">$${i.fullPrice}</span><button onclick="app.order.removeFromCart(${idx})" class="text-gray-300 hover:text-red-400 text-xs w-5 h-5 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); const total = app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0); document.getElementById('final-total').innerText = `$${total}`; },
                removeFromCart: (idx) => { app.state.cart.splice(idx, 1); app.order.showCartModal(); app.order.renderCartTotal(); },
                submit: async (e) => { e.preventDefault(); if(app.state.cart.length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); const name = document.getElementById('participant-name').value; const note = document.getElementById('participant-note').value; try { await addDoc(collection(window.db, "orders", app.state.currentOrder.id, "participants"), { name, note, items: app.state.cart, total: app.state.cart.reduce((sum, i) => sum + i.fullPrice, 0), createdAt: serverTimestamp() }); alert("è¨‚è³¼æˆåŠŸï¼ğŸ‰"); app.ui.closeModal('modal-submit-order'); app.state.cart = []; app.order.renderCartTotal(); document.getElementById('participant-name').value = ''; document.getElementById('participant-note').value = ''; } catch (err) { alert("é€å‡ºå¤±æ•—: " + err.message); } }
            },

            admin: {
                currentParticipants: [],
                init: async (orderId) => {
                    if (!window.db) return app.ui.showConfigModal();
                    const docSnap = await getDoc(doc(window.db, "orders", orderId));
                    if (!docSnap.exists()) return alert("Error");
                    const orderData = docSnap.data();
                    document.getElementById('admin-title').innerText = orderData.title;
                    document.getElementById('admin-order-id').innerText = orderId.substring(0,6);
                    if(orderData.storePhone) { const pEl = document.getElementById('admin-store-phone'); pEl.classList.remove('hidden'); pEl.querySelector('span').innerText = `åº—å®¶é›»è©±: ${orderData.storePhone}`; pEl.onclick = () => window.location.href = `tel:${orderData.storePhone}`; } else { document.getElementById('admin-store-phone').classList.add('hidden'); }
                    const shareUrl = `${app.state.baseUrl}?orderId=${orderId}`;
                    document.getElementById('share-link-input').value = shareUrl;
                    document.getElementById('qrcode-container').innerHTML = "";
                    new QRCode(document.getElementById('qrcode-container'), { text: shareUrl, width: 128, height: 128 });
                    onSnapshot(query(collection(window.db, "orders", orderId, "participants"), orderBy("createdAt", "desc")), (snapshot) => { app.admin.currentParticipants = snapshot.docs.map(d => d.data()); app.admin.renderStats(); app.admin.switchTab('items'); });
                },
                renderStats: () => { const parts = app.admin.currentParticipants; document.getElementById('admin-total-amount').innerText = `$${parts.reduce((sum, p) => sum + p.total, 0)}`; document.getElementById('admin-total-count').innerText = `${parts.length} äºº`; },
                switchTab: (tab) => {
                    const btnItems = document.getElementById('tab-items'); const btnPeople = document.getElementById('tab-people'); const container = document.getElementById('admin-list-container');
                    if (tab === 'items') {
                        btnItems.className = "flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-primary shadow-sm ring-1 ring-gray-100 transition-all"; btnPeople.className = "flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-600 transition-all";
                        const agg = {};
                        app.admin.currentParticipants.forEach(p => { p.items.forEach(i => { const key = i.name + (i.variantsText ? ` [${i.variantsText}]` : ''); if (!agg[key]) agg[key] = { qty: 0, total: 0 }; agg[key].qty += i.qty; agg[key].total += i.fullPrice; }); });
                        let html = '<table class="w-full text-sm text-left"><tr class="text-gray-400 border-b border-gray-100"><th class="pb-2 pl-2">å“é … (è¦æ ¼)</th><th class="pb-2 text-right">æ•¸é‡</th><th class="pb-2 text-right pr-2">å°è¨ˆ</th></tr>';
                        for (let key in agg) { html += `<tr class="border-b border-gray-50 last:border-0"><td class="py-3 pl-2 text-xs font-bold text-textMain">${key}</td><td class="text-right font-bold text-gray-500">${agg[key].qty}</td><td class="text-right pr-2 font-bold text-primary">$${agg[key].total}</td></tr>`; } html += '</table>'; container.innerHTML = html;
                    } else {
                        btnItems.className = "flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-600 transition-all"; btnPeople.className = "flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-primary shadow-sm ring-1 ring-gray-100 transition-all";
                        let html = '<div class="space-y-3">';
                        app.admin.currentParticipants.forEach(p => { const itemsStr = p.items.map(i => `<span class="bg-gray-100 px-1.5 rounded text-[10px] mr-1">${i.name} ${i.variantsText} x${i.qty}</span>`).join(''); html += `<div class="flex justify-between items-start bg-white p-3 rounded-2xl border border-gray-50 hover:border-secondary/30 transition"><div><p class="font-bold text-textMain text-sm">${p.name} <span class="text-xs text-primary font-normal bg-secondary/10 px-1 rounded ml-1">${p.note || ''}</span></p><div class="mt-2 flex flex-wrap gap-1">${itemsStr}</div></div><span class="font-bold text-primary">$${p.total}</span></div>`; }); html += '</div>'; container.innerHTML = html;
                    }
                },
                exportCSV: () => {
                    const parts = app.admin.currentParticipants; if (parts.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
                    let phoneText = ""; const pEl = document.getElementById('admin-store-phone'); if(pEl && !pEl.classList.contains('hidden')) { phoneText = pEl.querySelector('span').innerText.replace('åº—å®¶é›»è©±: ', '') || ''; }
                    let csv = `\uFEFFåº—å®¶é›»è©±:${phoneText}\nè¨‚è³¼äºº,å“é …å…§å®¹,å‚™è¨»,ç¸½é‡‘é¡,ä¸‹å–®æ™‚é–“\n`;
                    parts.forEach(p => { const itemsStr = p.items.map(i => `${i.name} ${i.variantsText} x${i.qty}`).join('; '); const time = p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleString() : ''; csv += `"${p.name}","${itemsStr}","${p.note || ''}",${p.total},"${time}"\n`; });
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `åœ˜è³¼è¨‚å–®_${new Date().toISOString().slice(0,10)}.csv`; link.click();
                }
            },

            ai: {
                scanMenu: async () => {
                    const fileInput = document.getElementById('menu-image-upload');
                    const statusEl = document.getElementById('scan-status');
                    
                    if (!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡");
                    
                    const mode = localStorage.getItem(`${appId}_ai_mode`) || 'default';
                    let apiKey = "";
                    if (mode === 'custom') { apiKey = localStorage.getItem(`${appId}_ai_key`); if (!apiKey) return alert("è‡ªè¨‚æ¨¡å¼è«‹å…ˆè¼¸å…¥ Key"); }

                    if(statusEl) statusEl.innerText = "ğŸ¤– AI æ­£åœ¨åˆ†æèœå–®åœ–ç‰‡...";
                    
                    try {
                        const base64Image = (await app.utils.fileToBase64(fileInput.files[0])).split(',')[1];
                        const prompt = `
                            Analyze this menu image. Return a JSON structure.
                            Format: {
                                "storeName": "Name extracted from menu",
                                "category": "Suggested category e.g. é¤é£Ÿ, é£²æ–™, etc.",
                                "phone": "extracted phone",
                                "orderLink": "extracted url",
                                "isDrinkStore": true/false (true if menu has sugar/ice levels or mostly drinks),
                                "menu": [{ "category": "Category Name", "items": [{ "name": "Item Name", "priceStr": "Price String" }] }],
                                "toppings": [{ "name": "Topping Name", "price": 10 }]
                            }
                            Rule for "priceStr":
                            1. If single price, e.g., 50.
                            2. If multiple sizes, use format "Size:Price", comma separated. e.g., "M:50, L:60" or "ä¸­:50, å¤§:60".
                            Rule for "toppings":
                            Extract items from sections like "Add-ons", "Toppings", "åŠ æ–™å€".
                            Language: Traditional Chinese. Pure JSON, no markdown.
                        `;
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                        const response = await fetch(url, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }] }] })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        // Robust JSON extraction
                        const text = data.candidates[0].content.parts[0].text;
                        const jsonStart = text.indexOf('{');
                        const jsonEnd = text.lastIndexOf('}');
                        if (jsonStart === -1 || jsonEnd === -1) throw new Error("ç„¡æ³•è§£æ AI å›å‚³çš„è³‡æ–™æ ¼å¼");
                        const jsonStr = text.substring(jsonStart, jsonEnd + 1);
                        
                        const result = JSON.parse(jsonStr);

                        // Populate Fields
                        if(result.storeName) document.querySelector('[name="storeName"]').value = result.storeName;
                        if(result.category) document.querySelector('[name="category"]').value = result.category;
                        if(result.phone) document.querySelector('[name="phone"]').value = result.phone;
                        if(result.orderLink) document.querySelector('[name="orderLink"]').value = result.orderLink;
                        if(result.isDrinkStore !== undefined) document.getElementById('is-drink-store').checked = result.isDrinkStore;

                        const container = document.getElementById('menu-editor-container');
                        container.innerHTML = '';
                        const items = result.menu || result; 
                        if (Array.isArray(items)) {
                            items.forEach(cat => {
                                const catId = Date.now() + Math.random().toString(16).slice(2);
                                app.store.addCategory(cat.category);
                                const lastCat = container.lastElementChild;
                                const lastId = lastCat.dataset.id;
                                lastCat.querySelector('.category-name').value = cat.category;
                                cat.items.forEach(i => app.store.addItemToCategory(lastId, i.name, i.priceStr));
                            });
                        }
                        
                        // Populate Toppings
                        if(result.toppings && Array.isArray(result.toppings)) {
                            result.toppings.forEach(t => app.store.addTopping(t.name, t.price));
                        }

                        if(statusEl) statusEl.innerText = "âœ… è¾¨è­˜æˆåŠŸï¼";
                        app.store.skipToForm();
                        document.getElementById('ai-success-msg').classList.remove('hidden');
                        
                        const previewUrl = URL.createObjectURL(fileInput.files[0]);
                        document.getElementById('img-preview').src = previewUrl;
                        document.getElementById('image-preview-area').classList.remove('hidden');

                    } catch (err) {
                        console.error(err);
                        if(statusEl) statusEl.innerText = "âŒ è¾¨è­˜å¤±æ•—: " + err.message;
                    }
                }
            },

            utils: {
                fileToBase64: (f) => new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f); }),
                resizeImage: (file) => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 800;
                            let w = img.width, h = img.height;
                            if (w > MAX) { h *= MAX / w; w = MAX; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }),
                copyLink: () => {
                    const copyText = document.getElementById("share-link-input");
                    copyText.select();
                    copyText.setSelectionRange(0, 99999);
                    try { document.execCommand("copy"); alert("é€£çµå·²è¤‡è£½ï¼ğŸ“‹"); } catch (err) { alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
                },
                renderPriceTags: (str) => {
                    const variants = app.utils.parsePriceVariants(str);
                    if (variants.length === 1 && variants[0].label === 'å–®ä¸€è¦æ ¼') {
                        return `<span class="text-xs font-bold text-primary bg-primary/10 border border-primary/20 px-2 py-1 rounded-lg">$${variants[0].price}</span>`;
                    }
                    return `<div class="flex flex-wrap gap-1.5">${variants.map(v => `<span class="inline-flex items-center text-[10px] font-bold text-gray-600 bg-white border-2 border-secondary/50 px-2 py-1 rounded-lg shadow-sm whitespace-nowrap">${v.label} <span class="text-primaryDark ml-1">$${v.price}</span></span>`).join('')}</div>`;
                },
                formatPriceRange: (str) => {
                    if(!str) return ''; if(!str.includes(':')) return `$${str}`;
                    const parts = str.split(/[,ï¼Œ]/).map(s => parseInt(s.split(/[:ï¼š]/)[1]));
                    const min = Math.min(...parts); const max = Math.max(...parts);
                    if(min === max) return `$${min}`; return `$${min} ~ $${max}`;
                },
                parsePriceVariants: (str) => {
                    if(!str.includes(':')) return [{label: 'å–®ä¸€è¦æ ¼', price: parseInt(str) || 0}];
                    return str.split(/[,ï¼Œ]/).map(s => { const [label, price] = s.split(/[:ï¼š]/); return { label: label.trim(), price: parseInt(price) || 0 }; });
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('paste', async (e) => {
                if(document.getElementById('modal-add-store').classList.contains('hidden')) return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        const fileInput = document.getElementById('menu-image-upload');
                        const file = new File([blob], "pasted_image.png", { type: blob.type });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        app.ai.scanMenu();
                        break;
                    }
                }
            });

            document.getElementById('menu-image-upload').addEventListener('change', async (e) => {
                if(e.target.files[0]) {
                   app.ai.scanMenu();
                }
            });
            app.init();
        });
    </script>
</body>
</html>